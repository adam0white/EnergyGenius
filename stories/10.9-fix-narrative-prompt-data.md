# Story 10.9: Fix Narrative Prompt - Handle Negative Savings and Add Missing Plan Details

**Epic:** Epic 10 - Critical Production Bugs
**Status:** Ready for Development
**Priority:** P0 - Critical (Incorrect Narratives)
**Complexity:** High
**Owner:** Dev Team

---

## User Story

As a user reading the "Why We Recommend This" narratives, I need accurate explanations that correctly describe whether I'll save or lose money, and include all relevant plan details (ETF, contract, plan type) so that I can make informed decisions.

---

## Problem Statement

**CRITICAL BUGS IN NARRATIVE GENERATION:**

### Issue 1: Negative Savings Not Understood
The LLM narrative prompt doesn't properly communicate when `estimatedSavings` is negative (meaning the user will LOSE money, not save).

**Current behavior:**
- Prompt always calls it "annual savings" even when negative
- LLM gets confused and might say "saves you $-93" or misinterpret the data
- Narratives don't clearly state "this costs MORE" when savings are negative

**Expected behavior:**
- If `estimatedSavings >= 0`: Call it "annual savings of $X"
- If `estimatedSavings < 0`: Call it "additional annual cost of $X" or "costs $X MORE per year"
- Narrative should clearly explain the financial trade-off

### Issue 2: Missing Plan Details in Narrative
The narrative doesn't include critical plan details that users need:
- **Early Termination Fee (ETF):** Not mentioned in narrative
- **Contract Length:** Not clearly stated in narrative context
- **Plan Type:** Not specified (fixed rate, variable, etc.)

**Current narrative example:**
> "This plan is recommended because it offers 100% renewable energy..."

**Should include:**
> "This plan is recommended because it offers 100% renewable energy with a 12-month contract and no early termination fee..."

---

## Root Cause Analysis

### For Parallel Narrative Generation:

**Location:** `src/worker/pipeline.ts` (lines 330-354) - `runNarrativeParallel()`

**Current prompt structure:**
```typescript
const prompt = `You are an energy plan expert...

Recommended Plan:
- Estimated Savings: $${plan.estimatedSavings}  // ← Always says "Savings" even if negative
```

**Problem:** No conditional logic to detect negative savings and adjust terminology.

### For Sequential Narrative Generation:

**Location:** `src/worker/prompts/narrative.ts` - `buildNarrativePrompt()`

**Current prompt:** Does include negative savings handling (lines 97-129) but may need verification and enhancement for parallel generation.

---

## Acceptance Criteria

### AC1: Fix Negative Savings Handling in Parallel Narrative

**Location:** `src/worker/pipeline.ts` - `runNarrativeParallel()` function

**Current Implementation:**
```typescript
Recommended Plan:
- Estimated Savings: $${plan.estimatedSavings}
```

**Required Fix:**
```typescript
// Add conditional logic for savings terminology
const savingsInfo = plan.estimatedSavings >= 0
  ? {
      term: "Estimated Annual Savings",
      value: `$${plan.estimatedSavings}`,
      explanation: `saves you $${plan.estimatedSavings}/year`
    }
  : {
      term: "Additional Annual Cost",
      value: `$${Math.abs(plan.estimatedSavings)}`,
      explanation: `costs $${Math.abs(plan.estimatedSavings)} MORE per year`
    };

const prompt = `You are an energy plan expert...

Recommended Plan:
- ${savingsInfo.term}: ${savingsInfo.value}

CRITICAL FINANCIAL INTERPRETATION:
${plan.estimatedSavings >= 0
  ? `This plan SAVES money - ${savingsInfo.explanation} compared to the current plan.`
  : `This plan COSTS MORE - ${savingsInfo.explanation} compared to the current plan. Explain the value proposition (renewable energy, better service, etc.) that justifies the higher cost.`
}
```

**Verification:**
- [ ] Positive savings: prompt says "saves you $X/year"
- [ ] Negative savings: prompt says "costs $X MORE per year"
- [ ] LLM generates correct narrative based on savings sign
- [ ] Test with both positive and negative savings examples

### AC2: Add Missing Plan Details to Prompt

**Required Fields to Add:**

1. **Early Termination Fee (ETF):**
```typescript
- Early Termination Fee: ${plan.earlyTerminationFee > 0 ? `$${plan.earlyTerminationFee}` : 'None (cancel anytime)'}
```

2. **Contract Length:**
```typescript
- Contract Term: ${plan.contractTermMonths} months
```

3. **Plan Type:**
```typescript
- Plan Type: Fixed Rate  // Or derive from plan data
```

**Updated Prompt Structure:**
```typescript
Recommended Plan:
- Plan ID: ${plan.planId}
- Supplier: ${plan.supplier}
- Plan Name: ${plan.planName}
- Score: ${plan.score}
- Estimated Annual Cost: $${plan.estimatedAnnualCost}
- ${savingsInfo.term}: ${savingsInfo.value}
- Base Rate: $${catalogPlan.baseRate}/kWh
- Monthly Service Fee: $${catalogPlan.monthlyFee}
- Contract Length: ${catalogPlan.contractTermMonths} months
- Early Termination Fee: ${catalogPlan.earlyTerminationFee > 0 ? `$${catalogPlan.earlyTerminationFee}` : 'None'}
- Renewable Energy: ${catalogPlan.renewablePercent}%
- Plan Type: Fixed Rate
```

**Verification:**
- [ ] All fields present in prompt
- [ ] LLM narrative mentions contract length
- [ ] LLM narrative mentions ETF (especially if $0)
- [ ] Narrative is more comprehensive

### AC3: Update Narrative Instructions

**Add clear instructions about required mentions:**

```typescript
Generate a compelling narrative (2-4 sentences) explaining:
1. Why this plan is recommended (match to usage pattern)
2. Key benefits: ${plan.estimatedSavings >= 0 ? 'savings' : 'value proposition despite higher cost'}
3. MUST mention: Contract length (${catalogPlan.contractTermMonths} months)
4. MUST mention: Early termination fee (${catalogPlan.earlyTerminationFee > 0 ? `$${catalogPlan.earlyTerminationFee}` : 'none - cancel anytime'})
5. Important considerations: Rate structure, renewable energy percentage

${plan.estimatedSavings >= 0
  ? 'Focus on: How much the user saves and why this plan offers good value.'
  : 'Focus on: What benefits justify the higher cost (renewable energy, service quality, rate stability).'
}
```

**Verification:**
- [ ] Narratives mention contract length
- [ ] Narratives mention ETF (especially when it's $0)
- [ ] Narratives explain trade-offs for higher-cost plans
- [ ] Narratives are more informative

### AC4: Verify Sequential Narrative Prompt

**Location:** `src/worker/prompts/narrative.ts`

**Check if already implemented:**
- [ ] Review lines 97-129 for negative savings handling
- [ ] Verify comprehensive plan details are included
- [ ] Ensure consistency with parallel narrative fixes

**If not implemented:**
- [ ] Apply same fixes to sequential narrative prompt
- [ ] Ensure both paths (parallel and sequential) have same data

### AC5: Test Narrative Quality

**Test Scenarios:**

**Scenario 1: Positive Savings, No ETF**
- Input: Plan with $214 savings, $0 ETF, 12-month contract
- Expected Narrative:
  > "This plan saves you $214 per year with 100% renewable energy. The 12-month contract has no early termination fee, giving you flexibility to switch if needed."

**Scenario 2: Negative Savings, With ETF**
- Input: Plan with -$93 savings, $150 ETF, 24-month contract
- Expected Narrative:
  > "While this plan costs $93 MORE per year, it offers 100% renewable energy from local wind farms. The 24-month contract includes a $150 early termination fee, so consider your commitment carefully."

**Scenario 3: Positive Savings, With ETF**
- Input: Plan with $340 savings, $95 ETF, 12-month contract
- Expected Narrative:
  > "This plan saves you $340 per year compared to your current plan. The competitive rate combined with a $95 early termination fee and 12-month contract provides good value for stable energy costs."

**Verification:**
- [ ] Generate narratives for all 3 scenarios
- [ ] Verify savings terminology is correct (saves vs costs MORE)
- [ ] Verify contract length mentioned
- [ ] Verify ETF mentioned (especially $0 = good feature)
- [ ] Narratives are clear and accurate

### AC6: Production Build and Validation

**Requirements:**
- [ ] Production build successful
- [ ] Generate recommendations with varied data
- [ ] Verify narratives correct for positive savings
- [ ] Verify narratives correct for negative savings
- [ ] Verify all plan details mentioned appropriately
- [ ] No LLM hallucinations or incorrect interpretations

---

## Tasks / Subtasks

- [ ] Fix negative savings handling in parallel narrative (AC1)
- [ ] Add missing plan details to prompt (AC2)
- [ ] Update narrative instructions (AC3)
- [ ] Verify sequential narrative prompt (AC4)
- [ ] Test narrative quality with scenarios (AC5)
- [ ] Production build and validation (AC6)

---

## Dev Notes

### Files to Modify

**Primary:**
- `src/worker/pipeline.ts` - Parallel narrative generation (lines 330-354)

**Verify/Update:**
- `src/worker/prompts/narrative.ts` - Sequential narrative generation

### Implementation Pattern

**1. Detect Savings Sign:**
```typescript
const isProfit = plan.estimatedSavings >= 0;
const savingsAmount = Math.abs(plan.estimatedSavings);
```

**2. Conditional Terminology:**
```typescript
const financialTerm = isProfit
  ? "Estimated Annual Savings"
  : "Additional Annual Cost";

const financialExplanation = isProfit
  ? `saves you $${savingsAmount} per year`
  : `costs $${savingsAmount} MORE per year than your current plan`;
```

**3. Conditional Instructions:**
```typescript
const focusArea = isProfit
  ? "Emphasize savings and value"
  : "Explain what benefits justify the higher cost (renewable energy, better service, etc.)";
```

### Expected Outcomes

After this fix:
- ✅ Narratives correctly say "saves" for positive savings
- ✅ Narratives correctly say "costs MORE" for negative savings
- ✅ Contract length mentioned in every narrative
- ✅ ETF mentioned in every narrative (especially highlighting $0 as a benefit)
- ✅ Users have complete information for decision-making

---

## Change Log

**2025-11-12 - Story Created**
- User reported narratives don't understand negative savings = loss
- User reported missing ETF, contract, plan type in narratives
- Investigation story created with 6 acceptance criteria
- Ready for Dev implementation
