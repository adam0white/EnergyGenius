
> energy-genius@0.0.0 test:run
> vitest run


 RUN  v3.2.4 /Users/abdul/Downloads/Projects/EnergyGenius

[vpw:warn] Workers AI and Vectorize bindings will access your Cloudflare account and incur usage charges even in testing. We recommend mocking any usage of these bindings in your tests.
[vpw:info] Starting isolated runtimes for vitest.config.mts...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-11". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-11". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-11". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-11". Falling back to "2025-09-06"...
 ✓ test/prompts/usage-summary.spec.ts (10 tests) 62ms
 ✓ test/useAutofillMockData.spec.ts (18 tests) 102ms
stdout | test/pipeline.spec.ts > Pipeline Stage Functions > runUsageSummary() > should return usage summary with correct metrics
[2025-11-11T15:27:48.581Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

stderr | test/pipeline.spec.ts > Pipeline Stage Functions > runUsageSummary() > should return usage summary with correct metrics
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parseUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:26:20)
    at runUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:138:37)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:79:19
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.585Z] [PARSE] [USAGE-SUMMARY] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Stage Functions > runUsageSummary() > should return usage summary with correct metrics
[2025-11-11T15:27:48.583Z] [PARSE] [USAGE-SUMMARY] Raw response (first 500 chars): Mock AI response

stdout | test/pipeline.spec.ts > Pipeline Stage Functions > runUsageSummary() > should call Workers AI with correct parameters
[2025-11-11T15:27:48.588Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

stdout | test/pipeline.spec.ts > Pipeline Stage Functions > runUsageSummary() > should call Workers AI with correct parameters
[2025-11-11T15:27:48.589Z] [PARSE] [USAGE-SUMMARY] Raw response (first 500 chars): Mock AI response

stderr | test/pipeline.spec.ts > Pipeline Stage Functions > runUsageSummary() > should call Workers AI with correct parameters
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parseUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:26:20)
    at runUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:138:37)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:98:4
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.589Z] [PARSE] [USAGE-SUMMARY] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Stage Functions > runPlanScoring() > should return scored plans array
[2025-11-11T15:27:48.594Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

stdout | test/pipeline.spec.ts > Pipeline Stage Functions > runPlanScoring() > should return scored plans array
[2025-11-11T15:27:48.594Z] [PARSE] [USAGE-SUMMARY] Raw response (first 500 chars): Mock AI response

stderr | test/pipeline.spec.ts > Pipeline Stage Functions > runPlanScoring() > should return scored plans array
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parseUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:26:20)
    at runUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:138:37)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:114:25
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.594Z] [PARSE] [USAGE-SUMMARY] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/index.spec.ts > EnergyGenius Worker > responds with health check endpoint
{"level":"INFO","requestId":"ty4g0h84a","type":"request_start","method":"GET","path":"/health","timestamp":"2025-11-11T15:27:48.595Z"}
{"level":"INFO","requestId":"ty4g0h84a","type":"health_check","status":"error","duration":0,"timestamp":"2025-11-11T15:27:48.596Z"}

stdout | test/index.spec.ts > EnergyGenius Worker > responds with health check endpoint
{"level":"ERROR","requestId":"ty4g0h84a","type":"request_end","method":"GET","path":"/health","status":503,"duration":1,"timestamp":"2025-11-11T15:27:48.596Z"}

stdout | test/pipeline.spec.ts > Pipeline Stage Functions > runPlanScoring() > should include plan details in each scored plan
[2025-11-11T15:27:48.596Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

stdout | test/pipeline.spec.ts > Pipeline Stage Functions > runPlanScoring() > should include plan details in each scored plan
[2025-11-11T15:27:48.597Z] [PARSE] [USAGE-SUMMARY] Raw response (first 500 chars): Mock AI response

stderr | test/pipeline.spec.ts > Pipeline Stage Functions > runPlanScoring() > should include plan details in each scored plan
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parseUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:26:20)
    at runUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:138:37)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:127:25
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.597Z] [PARSE] [USAGE-SUMMARY] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Stage Functions > runPlanScoring() > should calculate savings relative to current annual cost
[2025-11-11T15:27:48.602Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

stdout | test/pipeline.spec.ts > Pipeline Stage Functions > runPlanScoring() > should calculate savings relative to current annual cost
[2025-11-11T15:27:48.602Z] [PARSE] [USAGE-SUMMARY] Raw response (first 500 chars): Mock AI response

stderr | test/pipeline.spec.ts > Pipeline Stage Functions > runPlanScoring() > should calculate savings relative to current annual cost
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parseUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:26:20)
    at runUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:138:37)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:144:25
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.602Z] [PARSE] [USAGE-SUMMARY] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Stage Functions > runNarrative() > should return narrative explanation and recommendations
[2025-11-11T15:27:48.607Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

stdout | test/pipeline.spec.ts > Pipeline Stage Functions > runNarrative() > should return narrative explanation and recommendations
[2025-11-11T15:27:48.607Z] [PARSE] [USAGE-SUMMARY] Raw response (first 500 chars): Mock AI response

stderr | test/pipeline.spec.ts > Pipeline Stage Functions > runNarrative() > should return narrative explanation and recommendations
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parseUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:26:20)
    at runUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:138:37)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:159:25
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.607Z] [PARSE] [USAGE-SUMMARY] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Stage Functions > runNarrative() > should provide rationale for top 3 plans
[2025-11-11T15:27:48.611Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

stdout | test/pipeline.spec.ts > Pipeline Stage Functions > runNarrative() > should provide rationale for top 3 plans
[2025-11-11T15:27:48.611Z] [PARSE] [USAGE-SUMMARY] Raw response (first 500 chars): Mock AI response

 ✓ test/index.spec.ts (2 tests) 16ms
stderr | test/pipeline.spec.ts > Pipeline Stage Functions > runNarrative() > should provide rationale for top 3 plans
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parseUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:26:20)
    at runUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:138:37)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:173:25
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.611Z] [PARSE] [USAGE-SUMMARY] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should execute all three stages sequentially
[2025-11-11T15:27:48.617Z] [PIPELINE] Starting AI pipeline orchestration
[2025-11-11T15:27:48.617Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should execute all three stages sequentially
[2025-11-11T15:27:48.617Z] [PARSE] [USAGE-SUMMARY] Raw response (first 500 chars): Mock AI response

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should execute all three stages sequentially
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parseUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:26:20)
    at runUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:138:37)
    at withTimeout (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:384:18)
    at withRetry (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/lib/retry.ts:69:19)
    at runPipeline (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:249:18)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:202:19
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.617Z] [PARSE] [USAGE-SUMMARY] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should execute all three stages sequentially
[2025-11-11T15:27:48.617Z] [RETRY] [USAGE-SUMMARY] Attempt 1/2 failed: Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON (retriable: false)

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should execute all three stages sequentially
[2025-11-11T15:27:48.617Z] [FALLBACK] Using calculated usage summary fallback
[2025-11-11T15:27:48.617Z] [PLAN-SCORING] [RUNNING] Input size: 274 bytes

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should execute all three stages sequentially
[2025-11-11T15:27:48.617Z] [USAGE_SUMMARY] [ERROR] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should execute all three stages sequentially
[2025-11-11T15:27:48.618Z] [PARSE] [PLAN-SCORING] Raw response (first 500 chars): Mock AI response

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should execute all three stages sequentially
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parsePlanScoring (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:68:20)
    at runPlanScoring (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:176:36)
    at withTimeout (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:384:18)
    at withRetry (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/lib/retry.ts:69:19)
    at runPipeline (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:279:18)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:202:19
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.618Z] [PARSE] [PLAN-SCORING] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should execute all three stages sequentially
[2025-11-11T15:27:48.618Z] [RETRY] [PLAN-SCORING] Attempt 1/2 failed: Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON (retriable: false)

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should execute all three stages sequentially
[2025-11-11T15:27:48.618Z] [FALLBACK] Using neutral plan scoring fallback
[2025-11-11T15:27:48.618Z] [NARRATIVE] [RUNNING] Input size: 1466 bytes

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should execute all three stages sequentially
[2025-11-11T15:27:48.618Z] [PLAN_SCORING] [ERROR] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should execute all three stages sequentially
[2025-11-11T15:27:48.618Z] [PARSE] [NARRATIVE] Raw response (first 500 chars): Mock AI response

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should execute all three stages sequentially
[2025-11-11T15:27:48.618Z] [PARSE] [NARRATIVE] Response too short: 16 chars, expected at least 200

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should execute all three stages sequentially
[2025-11-11T15:27:48.618Z] [RETRY] [NARRATIVE] Attempt 1/2 failed: Response too short: 16 chars, expected at least 200 (retriable: false)

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should execute all three stages sequentially
[2025-11-11T15:27:48.618Z] [FALLBACK] Using generic narrative fallback
[2025-11-11T15:27:48.618Z] [PIPELINE] Pipeline completed in 1ms with 3 errors

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should execute all three stages sequentially
[2025-11-11T15:27:48.618Z] [NARRATIVE] [ERROR] Response too short: 16 chars, expected at least 200

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should return PipelineResult with metadata
[2025-11-11T15:27:48.622Z] [PIPELINE] Starting AI pipeline orchestration
[2025-11-11T15:27:48.622Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should return PipelineResult with metadata
[2025-11-11T15:27:48.622Z] [PARSE] [USAGE-SUMMARY] Raw response (first 500 chars): Mock AI response

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should return PipelineResult with metadata
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parseUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:26:20)
    at runUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:138:37)
    at withTimeout (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:384:18)
    at withRetry (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/lib/retry.ts:69:19)
    at runPipeline (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:249:18)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:216:19
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.622Z] [PARSE] [USAGE-SUMMARY] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should return PipelineResult with metadata
[2025-11-11T15:27:48.622Z] [RETRY] [USAGE-SUMMARY] Attempt 1/2 failed: Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON (retriable: false)

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should return PipelineResult with metadata
[2025-11-11T15:27:48.622Z] [FALLBACK] Using calculated usage summary fallback
[2025-11-11T15:27:48.622Z] [PLAN-SCORING] [RUNNING] Input size: 274 bytes

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should return PipelineResult with metadata
[2025-11-11T15:27:48.622Z] [USAGE_SUMMARY] [ERROR] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should return PipelineResult with metadata
[2025-11-11T15:27:48.622Z] [PARSE] [PLAN-SCORING] Raw response (first 500 chars): Mock AI response

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should return PipelineResult with metadata
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parsePlanScoring (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:68:20)
    at runPlanScoring (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:176:36)
    at withTimeout (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:384:18)
    at withRetry (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/lib/retry.ts:69:19)
    at runPipeline (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:279:18)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:216:19
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.622Z] [PARSE] [PLAN-SCORING] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should return PipelineResult with metadata
[2025-11-11T15:27:48.622Z] [RETRY] [PLAN-SCORING] Attempt 1/2 failed: Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON (retriable: false)

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should return PipelineResult with metadata
[2025-11-11T15:27:48.622Z] [FALLBACK] Using neutral plan scoring fallback
[2025-11-11T15:27:48.622Z] [NARRATIVE] [RUNNING] Input size: 1466 bytes

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should return PipelineResult with metadata
[2025-11-11T15:27:48.622Z] [PLAN_SCORING] [ERROR] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should return PipelineResult with metadata
[2025-11-11T15:27:48.622Z] [PARSE] [NARRATIVE] Raw response (first 500 chars): Mock AI response

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should return PipelineResult with metadata
[2025-11-11T15:27:48.622Z] [PARSE] [NARRATIVE] Response too short: 16 chars, expected at least 200

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should return PipelineResult with metadata
[2025-11-11T15:27:48.622Z] [RETRY] [NARRATIVE] Attempt 1/2 failed: Response too short: 16 chars, expected at least 200 (retriable: false)

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should return PipelineResult with metadata
[2025-11-11T15:27:48.622Z] [FALLBACK] Using generic narrative fallback
[2025-11-11T15:27:48.622Z] [PIPELINE] Pipeline completed in 0ms with 3 errors

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should return PipelineResult with metadata
[2025-11-11T15:27:48.622Z] [NARRATIVE] [ERROR] Response too short: 16 chars, expected at least 200

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should have zero errors on successful run
[2025-11-11T15:27:48.626Z] [PIPELINE] Starting AI pipeline orchestration
[2025-11-11T15:27:48.626Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should have zero errors on successful run
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parseUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:26:20)
    at runUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:138:37)
    at withTimeout (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:384:18)
    at withRetry (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/lib/retry.ts:69:19)
    at runPipeline (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:249:18)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:230:19
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.627Z] [PARSE] [USAGE-SUMMARY] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should have zero errors on successful run
[2025-11-11T15:27:48.627Z] [PARSE] [USAGE-SUMMARY] Raw response (first 500 chars): Mock AI response

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should have zero errors on successful run
[2025-11-11T15:27:48.627Z] [RETRY] [USAGE-SUMMARY] Attempt 1/2 failed: Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON (retriable: false)

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should have zero errors on successful run
[2025-11-11T15:27:48.627Z] [FALLBACK] Using calculated usage summary fallback
[2025-11-11T15:27:48.627Z] [PLAN-SCORING] [RUNNING] Input size: 274 bytes

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should have zero errors on successful run
[2025-11-11T15:27:48.627Z] [USAGE_SUMMARY] [ERROR] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should have zero errors on successful run
[2025-11-11T15:27:48.627Z] [PARSE] [PLAN-SCORING] Raw response (first 500 chars): Mock AI response

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should have zero errors on successful run
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parsePlanScoring (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:68:20)
    at runPlanScoring (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:176:36)
    at withTimeout (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:384:18)
    at withRetry (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/lib/retry.ts:69:19)
    at runPipeline (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:279:18)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:230:19
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.627Z] [PARSE] [PLAN-SCORING] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should have zero errors on successful run
[2025-11-11T15:27:48.627Z] [RETRY] [PLAN-SCORING] Attempt 1/2 failed: Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON (retriable: false)

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should have zero errors on successful run
[2025-11-11T15:27:48.627Z] [FALLBACK] Using neutral plan scoring fallback
[2025-11-11T15:27:48.627Z] [NARRATIVE] [RUNNING] Input size: 1466 bytes

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should have zero errors on successful run
[2025-11-11T15:27:48.627Z] [PLAN_SCORING] [ERROR] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should have zero errors on successful run
[2025-11-11T15:27:48.627Z] [PARSE] [NARRATIVE] Raw response (first 500 chars): Mock AI response

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should have zero errors on successful run
[2025-11-11T15:27:48.627Z] [PARSE] [NARRATIVE] Response too short: 16 chars, expected at least 200

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should have zero errors on successful run
[2025-11-11T15:27:48.627Z] [RETRY] [NARRATIVE] Attempt 1/2 failed: Response too short: 16 chars, expected at least 200 (retriable: false)

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should have zero errors on successful run
[2025-11-11T15:27:48.627Z] [FALLBACK] Using generic narrative fallback
[2025-11-11T15:27:48.627Z] [PIPELINE] Pipeline completed in 1ms with 3 errors

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should have zero errors on successful run
[2025-11-11T15:27:48.627Z] [NARRATIVE] [ERROR] Response too short: 16 chars, expected at least 200

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should track execution time
[2025-11-11T15:27:48.631Z] [PIPELINE] Starting AI pipeline orchestration
[2025-11-11T15:27:48.631Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should track execution time
[2025-11-11T15:27:48.631Z] [PARSE] [USAGE-SUMMARY] Raw response (first 500 chars): Mock AI response

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should track execution time
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parseUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:26:20)
    at runUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:138:37)
    at withTimeout (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:384:18)
    at withRetry (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/lib/retry.ts:69:19)
    at runPipeline (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:249:18)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:239:19
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.631Z] [PARSE] [USAGE-SUMMARY] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should track execution time
[2025-11-11T15:27:48.631Z] [RETRY] [USAGE-SUMMARY] Attempt 1/2 failed: Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON (retriable: false)

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should track execution time
[2025-11-11T15:27:48.631Z] [FALLBACK] Using calculated usage summary fallback
[2025-11-11T15:27:48.631Z] [PLAN-SCORING] [RUNNING] Input size: 274 bytes

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should track execution time
[2025-11-11T15:27:48.631Z] [USAGE_SUMMARY] [ERROR] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should track execution time
[2025-11-11T15:27:48.631Z] [PARSE] [PLAN-SCORING] Raw response (first 500 chars): Mock AI response

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should track execution time
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parsePlanScoring (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:68:20)
    at runPlanScoring (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:176:36)
    at withTimeout (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:384:18)
    at withRetry (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/lib/retry.ts:69:19)
    at runPipeline (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:279:18)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:239:19
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.631Z] [PARSE] [PLAN-SCORING] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should track execution time
[2025-11-11T15:27:48.631Z] [RETRY] [PLAN-SCORING] Attempt 1/2 failed: Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON (retriable: false)

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should track execution time
[2025-11-11T15:27:48.631Z] [FALLBACK] Using neutral plan scoring fallback
[2025-11-11T15:27:48.631Z] [NARRATIVE] [RUNNING] Input size: 1466 bytes

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should track execution time
[2025-11-11T15:27:48.631Z] [PLAN_SCORING] [ERROR] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should track execution time
[2025-11-11T15:27:48.631Z] [PARSE] [NARRATIVE] Raw response (first 500 chars): Mock AI response

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should track execution time
[2025-11-11T15:27:48.631Z] [PARSE] [NARRATIVE] Response too short: 16 chars, expected at least 200

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should track execution time
[2025-11-11T15:27:48.631Z] [RETRY] [NARRATIVE] Attempt 1/2 failed: Response too short: 16 chars, expected at least 200 (retriable: false)

stdout | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should track execution time
[2025-11-11T15:27:48.631Z] [FALLBACK] Using generic narrative fallback
[2025-11-11T15:27:48.631Z] [PIPELINE] Pipeline completed in 0ms with 3 errors

stderr | test/pipeline.spec.ts > Pipeline Orchestration > runPipeline() > should track execution time
[2025-11-11T15:27:48.631Z] [NARRATIVE] [ERROR] Response too short: 16 chars, expected at least 200

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should await Stage 1 before executing Stage 2
[2025-11-11T15:27:48.636Z] [PIPELINE] Starting AI pipeline orchestration
[2025-11-11T15:27:48.636Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should await Stage 1 before executing Stage 2
[2025-11-11T15:27:48.636Z] [PARSE] [USAGE-SUMMARY] Raw response (first 500 chars): Mock

stderr | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should await Stage 1 before executing Stage 2
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parseUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:26:20)
    at runUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:138:37)
    at withTimeout (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:384:18)
    at withRetry (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/lib/retry.ts:69:19)
    at runPipeline (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:249:18)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:258:19
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.636Z] [PARSE] [USAGE-SUMMARY] Failed to parse JSON response: Unexpected token 'M', "Mock" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should await Stage 1 before executing Stage 2
[2025-11-11T15:27:48.636Z] [RETRY] [USAGE-SUMMARY] Attempt 1/2 failed: Failed to parse JSON response: Unexpected token 'M', "Mock" is not valid JSON (retriable: false)

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should await Stage 1 before executing Stage 2
[2025-11-11T15:27:48.636Z] [FALLBACK] Using calculated usage summary fallback
[2025-11-11T15:27:48.636Z] [PLAN-SCORING] [RUNNING] Input size: 274 bytes

stderr | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should await Stage 1 before executing Stage 2
[2025-11-11T15:27:48.636Z] [USAGE_SUMMARY] [ERROR] Failed to parse JSON response: Unexpected token 'M', "Mock" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should await Stage 1 before executing Stage 2
[2025-11-11T15:27:48.636Z] [PARSE] [PLAN-SCORING] Raw response (first 500 chars): Mock

stderr | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should await Stage 1 before executing Stage 2
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parsePlanScoring (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:68:20)
    at runPlanScoring (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:176:36)
    at withTimeout (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:384:18)
    at withRetry (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/lib/retry.ts:69:19)
    at runPipeline (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:279:18)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:258:19
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.636Z] [PARSE] [PLAN-SCORING] Failed to parse JSON response: Unexpected token 'M', "Mock" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should await Stage 1 before executing Stage 2
[2025-11-11T15:27:48.636Z] [RETRY] [PLAN-SCORING] Attempt 1/2 failed: Failed to parse JSON response: Unexpected token 'M', "Mock" is not valid JSON (retriable: false)

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should await Stage 1 before executing Stage 2
[2025-11-11T15:27:48.636Z] [FALLBACK] Using neutral plan scoring fallback
[2025-11-11T15:27:48.636Z] [NARRATIVE] [RUNNING] Input size: 1466 bytes

stderr | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should await Stage 1 before executing Stage 2
[2025-11-11T15:27:48.636Z] [PLAN_SCORING] [ERROR] Failed to parse JSON response: Unexpected token 'M', "Mock" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should await Stage 1 before executing Stage 2
[2025-11-11T15:27:48.636Z] [PARSE] [NARRATIVE] Raw response (first 500 chars): Mock

stderr | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should await Stage 1 before executing Stage 2
[2025-11-11T15:27:48.636Z] [PARSE] [NARRATIVE] Response too short: 4 chars, expected at least 200

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should await Stage 1 before executing Stage 2
[2025-11-11T15:27:48.636Z] [RETRY] [NARRATIVE] Attempt 1/2 failed: Response too short: 4 chars, expected at least 200 (retriable: false)

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should await Stage 1 before executing Stage 2
[2025-11-11T15:27:48.636Z] [FALLBACK] Using generic narrative fallback
[2025-11-11T15:27:48.636Z] [PIPELINE] Pipeline completed in 0ms with 3 errors

stderr | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should await Stage 1 before executing Stage 2
[2025-11-11T15:27:48.636Z] [NARRATIVE] [ERROR] Response too short: 4 chars, expected at least 200

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 1 output to Stage 2
[2025-11-11T15:27:48.638Z] [PIPELINE] Starting AI pipeline orchestration
[2025-11-11T15:27:48.638Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 1 output to Stage 2
[2025-11-11T15:27:48.638Z] [PARSE] [USAGE-SUMMARY] Raw response (first 500 chars): Mock AI response

stderr | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 1 output to Stage 2
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parseUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:26:20)
    at runUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:138:37)
    at withTimeout (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:384:18)
    at withRetry (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/lib/retry.ts:69:19)
    at runPipeline (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:249:18)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:271:19
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.638Z] [PARSE] [USAGE-SUMMARY] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 1 output to Stage 2
[2025-11-11T15:27:48.639Z] [RETRY] [USAGE-SUMMARY] Attempt 1/2 failed: Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON (retriable: false)

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 1 output to Stage 2
[2025-11-11T15:27:48.639Z] [FALLBACK] Using calculated usage summary fallback
[2025-11-11T15:27:48.639Z] [PLAN-SCORING] [RUNNING] Input size: 274 bytes

stderr | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 1 output to Stage 2
[2025-11-11T15:27:48.639Z] [USAGE_SUMMARY] [ERROR] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 1 output to Stage 2
[2025-11-11T15:27:48.639Z] [PARSE] [PLAN-SCORING] Raw response (first 500 chars): Mock AI response

stderr | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 1 output to Stage 2
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parsePlanScoring (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:68:20)
    at runPlanScoring (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:176:36)
    at withTimeout (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:384:18)
    at withRetry (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/lib/retry.ts:69:19)
    at runPipeline (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:279:18)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:271:19
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.639Z] [PARSE] [PLAN-SCORING] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 1 output to Stage 2
[2025-11-11T15:27:48.639Z] [RETRY] [PLAN-SCORING] Attempt 1/2 failed: Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON (retriable: false)

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 1 output to Stage 2
[2025-11-11T15:27:48.639Z] [FALLBACK] Using neutral plan scoring fallback
[2025-11-11T15:27:48.639Z] [NARRATIVE] [RUNNING] Input size: 1466 bytes

stderr | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 1 output to Stage 2
[2025-11-11T15:27:48.639Z] [PLAN_SCORING] [ERROR] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 1 output to Stage 2
[2025-11-11T15:27:48.639Z] [PARSE] [NARRATIVE] Raw response (first 500 chars): Mock AI response

stderr | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 1 output to Stage 2
[2025-11-11T15:27:48.639Z] [PARSE] [NARRATIVE] Response too short: 16 chars, expected at least 200

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 1 output to Stage 2
[2025-11-11T15:27:48.639Z] [RETRY] [NARRATIVE] Attempt 1/2 failed: Response too short: 16 chars, expected at least 200 (retriable: false)

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 1 output to Stage 2
[2025-11-11T15:27:48.639Z] [FALLBACK] Using generic narrative fallback
[2025-11-11T15:27:48.639Z] [PIPELINE] Pipeline completed in 1ms with 3 errors

stderr | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 1 output to Stage 2
[2025-11-11T15:27:48.639Z] [NARRATIVE] [ERROR] Response too short: 16 chars, expected at least 200

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 2 output to Stage 3
[2025-11-11T15:27:48.641Z] [PIPELINE] Starting AI pipeline orchestration
[2025-11-11T15:27:48.641Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 2 output to Stage 3
[2025-11-11T15:27:48.641Z] [PARSE] [USAGE-SUMMARY] Raw response (first 500 chars): Mock AI response

stderr | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 2 output to Stage 3
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parseUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:26:20)
    at runUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:138:37)
    at withTimeout (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:384:18)
    at withRetry (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/lib/retry.ts:69:19)
    at runPipeline (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:249:18)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:281:19
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.641Z] [PARSE] [USAGE-SUMMARY] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 2 output to Stage 3
[2025-11-11T15:27:48.641Z] [RETRY] [USAGE-SUMMARY] Attempt 1/2 failed: Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON (retriable: false)

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 2 output to Stage 3
[2025-11-11T15:27:48.641Z] [FALLBACK] Using calculated usage summary fallback
[2025-11-11T15:27:48.641Z] [PLAN-SCORING] [RUNNING] Input size: 274 bytes

stderr | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 2 output to Stage 3
[2025-11-11T15:27:48.641Z] [USAGE_SUMMARY] [ERROR] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 2 output to Stage 3
[2025-11-11T15:27:48.641Z] [PARSE] [PLAN-SCORING] Raw response (first 500 chars): Mock AI response

stderr | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 2 output to Stage 3
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parsePlanScoring (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:68:20)
    at runPlanScoring (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:176:36)
    at withTimeout (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:384:18)
    at withRetry (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/lib/retry.ts:69:19)
    at runPipeline (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:279:18)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:281:19
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.642Z] [PARSE] [PLAN-SCORING] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 2 output to Stage 3
[2025-11-11T15:27:48.642Z] [RETRY] [PLAN-SCORING] Attempt 1/2 failed: Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON (retriable: false)

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 2 output to Stage 3
[2025-11-11T15:27:48.642Z] [FALLBACK] Using neutral plan scoring fallback
[2025-11-11T15:27:48.642Z] [NARRATIVE] [RUNNING] Input size: 1466 bytes

stderr | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 2 output to Stage 3
[2025-11-11T15:27:48.642Z] [PLAN_SCORING] [ERROR] Failed to parse JSON response: Unexpected token 'M', "Mock AI response" is not valid JSON

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 2 output to Stage 3
[2025-11-11T15:27:48.642Z] [PARSE] [NARRATIVE] Raw response (first 500 chars): Mock AI response

stderr | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 2 output to Stage 3
[2025-11-11T15:27:48.642Z] [PARSE] [NARRATIVE] Response too short: 16 chars, expected at least 200

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 2 output to Stage 3
[2025-11-11T15:27:48.642Z] [RETRY] [NARRATIVE] Attempt 1/2 failed: Response too short: 16 chars, expected at least 200 (retriable: false)

stdout | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 2 output to Stage 3
[2025-11-11T15:27:48.642Z] [FALLBACK] Using generic narrative fallback
[2025-11-11T15:27:48.642Z] [PIPELINE] Pipeline completed in 1ms with 3 errors

stderr | test/pipeline.spec.ts > Pipeline Orchestration > Sequential Execution & Data Flow > should pass Stage 2 output to Stage 3
[2025-11-11T15:27:48.642Z] [NARRATIVE] [ERROR] Response too short: 16 chars, expected at least 200

stdout | test/pipeline.spec.ts > Error Handling > should catch and store stage errors
[2025-11-11T15:27:48.647Z] [PIPELINE] Starting AI pipeline orchestration
[2025-11-11T15:27:48.647Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

stdout | test/pipeline.spec.ts > Error Handling > should catch and store stage errors
[2025-11-11T15:27:48.647Z] [RETRY] [USAGE-SUMMARY] Attempt 1/2 failed: AI service unavailable (retriable: false)

stdout | test/pipeline.spec.ts > Error Handling > should catch and store stage errors
[2025-11-11T15:27:48.647Z] [FALLBACK] Using calculated usage summary fallback
[2025-11-11T15:27:48.647Z] [PLAN-SCORING] [RUNNING] Input size: 274 bytes

stderr | test/pipeline.spec.ts > Error Handling > should catch and store stage errors
[2025-11-11T15:27:48.647Z] [USAGE_SUMMARY] [ERROR] AI service unavailable

stdout | test/pipeline.spec.ts > Error Handling > should catch and store stage errors
[2025-11-11T15:27:48.647Z] [RETRY] [PLAN-SCORING] Attempt 1/2 failed: AI service unavailable (retriable: false)

stdout | test/pipeline.spec.ts > Error Handling > should catch and store stage errors
[2025-11-11T15:27:48.647Z] [FALLBACK] Using neutral plan scoring fallback
[2025-11-11T15:27:48.647Z] [NARRATIVE] [RUNNING] Input size: 1466 bytes

stderr | test/pipeline.spec.ts > Error Handling > should catch and store stage errors
[2025-11-11T15:27:48.647Z] [PLAN_SCORING] [ERROR] AI service unavailable

stdout | test/pipeline.spec.ts > Error Handling > should catch and store stage errors
[2025-11-11T15:27:48.647Z] [RETRY] [NARRATIVE] Attempt 1/2 failed: AI service unavailable (retriable: false)

stdout | test/pipeline.spec.ts > Error Handling > should catch and store stage errors
[2025-11-11T15:27:48.647Z] [FALLBACK] Using generic narrative fallback
[2025-11-11T15:27:48.647Z] [PIPELINE] Pipeline completed in 0ms with 3 errors

stderr | test/pipeline.spec.ts > Error Handling > should catch and store stage errors
[2025-11-11T15:27:48.647Z] [NARRATIVE] [ERROR] AI service unavailable

stdout | test/pipeline.spec.ts > Error Handling > should continue pipeline after stage error (partial results)
[2025-11-11T15:27:48.650Z] [PIPELINE] Starting AI pipeline orchestration
[2025-11-11T15:27:48.650Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

stdout | test/pipeline.spec.ts > Error Handling > should continue pipeline after stage error (partial results)
[2025-11-11T15:27:48.650Z] [PARSE] [USAGE-SUMMARY] Raw response (first 500 chars): Mock

stderr | test/pipeline.spec.ts > Error Handling > should continue pipeline after stage error (partial results)
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parseUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:26:20)
    at runUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:138:37)
    at withTimeout (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:384:18)
    at withRetry (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/lib/retry.ts:69:19)
    at runPipeline (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:249:18)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:329:18
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.650Z] [PARSE] [USAGE-SUMMARY] Failed to parse JSON response: Unexpected token 'M', "Mock" is not valid JSON

stdout | test/pipeline.spec.ts > Error Handling > should continue pipeline after stage error (partial results)
[2025-11-11T15:27:48.650Z] [RETRY] [USAGE-SUMMARY] Attempt 1/2 failed: Failed to parse JSON response: Unexpected token 'M', "Mock" is not valid JSON (retriable: false)

stdout | test/pipeline.spec.ts > Error Handling > should continue pipeline after stage error (partial results)
[2025-11-11T15:27:48.650Z] [FALLBACK] Using calculated usage summary fallback
[2025-11-11T15:27:48.650Z] [PLAN-SCORING] [RUNNING] Input size: 274 bytes

stderr | test/pipeline.spec.ts > Error Handling > should continue pipeline after stage error (partial results)
[2025-11-11T15:27:48.650Z] [USAGE_SUMMARY] [ERROR] Failed to parse JSON response: Unexpected token 'M', "Mock" is not valid JSON

stdout | test/pipeline.spec.ts > Error Handling > should continue pipeline after stage error (partial results)
[2025-11-11T15:27:48.650Z] [RETRY] [PLAN-SCORING] Attempt 1/2 failed: Stage 2 failed (retriable: false)

stdout | test/pipeline.spec.ts > Error Handling > should continue pipeline after stage error (partial results)
[2025-11-11T15:27:48.650Z] [FALLBACK] Using neutral plan scoring fallback
[2025-11-11T15:27:48.650Z] [NARRATIVE] [RUNNING] Input size: 1466 bytes

stderr | test/pipeline.spec.ts > Error Handling > should continue pipeline after stage error (partial results)
[2025-11-11T15:27:48.650Z] [PLAN_SCORING] [ERROR] Stage 2 failed

stdout | test/pipeline.spec.ts > Error Handling > should continue pipeline after stage error (partial results)
[2025-11-11T15:27:48.650Z] [PARSE] [NARRATIVE] Raw response (first 500 chars): Mock

stderr | test/pipeline.spec.ts > Error Handling > should continue pipeline after stage error (partial results)
[2025-11-11T15:27:48.650Z] [PARSE] [NARRATIVE] Response too short: 4 chars, expected at least 200

stdout | test/pipeline.spec.ts > Error Handling > should continue pipeline after stage error (partial results)
[2025-11-11T15:27:48.650Z] [RETRY] [NARRATIVE] Attempt 1/2 failed: Response too short: 4 chars, expected at least 200 (retriable: false)

stdout | test/pipeline.spec.ts > Error Handling > should continue pipeline after stage error (partial results)
[2025-11-11T15:27:48.650Z] [FALLBACK] Using generic narrative fallback
[2025-11-11T15:27:48.650Z] [PIPELINE] Pipeline completed in 0ms with 3 errors

stderr | test/pipeline.spec.ts > Error Handling > should continue pipeline after stage error (partial results)
[2025-11-11T15:27:48.650Z] [NARRATIVE] [ERROR] Response too short: 4 chars, expected at least 200

stdout | test/pipeline.spec.ts > Error Handling > should include user-friendly error messages
[2025-11-11T15:27:48.653Z] [PIPELINE] Starting AI pipeline orchestration
[2025-11-11T15:27:48.653Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

stdout | test/pipeline.spec.ts > Error Handling > should include user-friendly error messages
[2025-11-11T15:27:48.653Z] [RETRY] [USAGE-SUMMARY] Attempt 1/2 failed: Network timeout (retriable: true)
[2025-11-11T15:27:48.653Z] [RETRY] [USAGE-SUMMARY] Waiting 100ms before retry...

stdout | test/pipeline.spec.ts > Error Handling > should include user-friendly error messages
[2025-11-11T15:27:48.754Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

stdout | test/pipeline.spec.ts > Error Handling > should include user-friendly error messages
[2025-11-11T15:27:48.755Z] [RETRY] [USAGE-SUMMARY] Attempt 2/2 failed: Network timeout (retriable: true)

stderr | test/pipeline.spec.ts > Error Handling > should include user-friendly error messages
[2025-11-11T15:27:48.755Z] [USAGE_SUMMARY] [ERROR] Network timeout

stdout | test/pipeline.spec.ts > Error Handling > should include user-friendly error messages
[2025-11-11T15:27:48.755Z] [FALLBACK] Using calculated usage summary fallback
[2025-11-11T15:27:48.755Z] [PLAN-SCORING] [RUNNING] Input size: 274 bytes

stdout | test/pipeline.spec.ts > Error Handling > should include user-friendly error messages
[2025-11-11T15:27:48.755Z] [RETRY] [PLAN-SCORING] Attempt 1/2 failed: Network timeout (retriable: true)
[2025-11-11T15:27:48.755Z] [RETRY] [PLAN-SCORING] Waiting 100ms before retry...

stdout | test/pipeline.spec.ts > Error Handling > should include user-friendly error messages
[2025-11-11T15:27:48.855Z] [PLAN-SCORING] [RUNNING] Input size: 274 bytes

stdout | test/pipeline.spec.ts > Error Handling > should include user-friendly error messages
[2025-11-11T15:27:48.855Z] [RETRY] [PLAN-SCORING] Attempt 2/2 failed: Network timeout (retriable: true)

stdout | test/pipeline.spec.ts > Error Handling > should include user-friendly error messages
[2025-11-11T15:27:48.855Z] [FALLBACK] Using neutral plan scoring fallback
[2025-11-11T15:27:48.855Z] [NARRATIVE] [RUNNING] Input size: 1466 bytes

stderr | test/pipeline.spec.ts > Error Handling > should include user-friendly error messages
[2025-11-11T15:27:48.855Z] [PLAN_SCORING] [ERROR] Network timeout

stdout | test/pipeline.spec.ts > Error Handling > should include user-friendly error messages
[2025-11-11T15:27:48.855Z] [RETRY] [NARRATIVE] Attempt 1/2 failed: Network timeout (retriable: true)
[2025-11-11T15:27:48.855Z] [RETRY] [NARRATIVE] Waiting 100ms before retry...

stdout | test/pipeline.spec.ts > Error Handling > should include user-friendly error messages
[2025-11-11T15:27:48.954Z] [NARRATIVE] [RUNNING] Input size: 1466 bytes

stdout | test/pipeline.spec.ts > Error Handling > should include user-friendly error messages
[2025-11-11T15:27:48.954Z] [RETRY] [NARRATIVE] Attempt 2/2 failed: Network timeout (retriable: true)

stdout | test/pipeline.spec.ts > Error Handling > should include user-friendly error messages
[2025-11-11T15:27:48.954Z] [FALLBACK] Using generic narrative fallback
[2025-11-11T15:27:48.954Z] [PIPELINE] Pipeline completed in 301ms with 3 errors

stderr | test/pipeline.spec.ts > Error Handling > should include user-friendly error messages
[2025-11-11T15:27:48.954Z] [NARRATIVE] [ERROR] Network timeout

stdout | test/pipeline.spec.ts > Error Handling > should skip Stage 2 if Stage 1 fails
[2025-11-11T15:27:48.960Z] [PIPELINE] Starting AI pipeline orchestration
[2025-11-11T15:27:48.960Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

stdout | test/pipeline.spec.ts > Error Handling > should skip Stage 2 if Stage 1 fails
[2025-11-11T15:27:48.960Z] [RETRY] [USAGE-SUMMARY] Attempt 1/2 failed: Stage 1 failed (retriable: false)

stdout | test/pipeline.spec.ts > Error Handling > should skip Stage 2 if Stage 1 fails
[2025-11-11T15:27:48.960Z] [FALLBACK] Using calculated usage summary fallback
[2025-11-11T15:27:48.960Z] [PLAN-SCORING] [RUNNING] Input size: 274 bytes

stderr | test/pipeline.spec.ts > Error Handling > should skip Stage 2 if Stage 1 fails
[2025-11-11T15:27:48.960Z] [USAGE_SUMMARY] [ERROR] Stage 1 failed

stdout | test/pipeline.spec.ts > Error Handling > should skip Stage 2 if Stage 1 fails
[2025-11-11T15:27:48.960Z] [RETRY] [PLAN-SCORING] Attempt 1/2 failed: Stage 1 failed (retriable: false)

stdout | test/pipeline.spec.ts > Error Handling > should skip Stage 2 if Stage 1 fails
[2025-11-11T15:27:48.960Z] [FALLBACK] Using neutral plan scoring fallback
[2025-11-11T15:27:48.960Z] [NARRATIVE] [RUNNING] Input size: 1466 bytes

stderr | test/pipeline.spec.ts > Error Handling > should skip Stage 2 if Stage 1 fails
[2025-11-11T15:27:48.960Z] [PLAN_SCORING] [ERROR] Stage 1 failed

stdout | test/pipeline.spec.ts > Error Handling > should skip Stage 2 if Stage 1 fails
[2025-11-11T15:27:48.961Z] [RETRY] [NARRATIVE] Attempt 1/2 failed: Stage 1 failed (retriable: false)

stdout | test/pipeline.spec.ts > Error Handling > should skip Stage 2 if Stage 1 fails
[2025-11-11T15:27:48.961Z] [FALLBACK] Using generic narrative fallback
[2025-11-11T15:27:48.961Z] [PIPELINE] Pipeline completed in 1ms with 3 errors

stderr | test/pipeline.spec.ts > Error Handling > should skip Stage 2 if Stage 1 fails
[2025-11-11T15:27:48.961Z] [NARRATIVE] [ERROR] Stage 1 failed

stdout | test/pipeline.spec.ts > Error Handling > should skip Stage 3 if Stage 2 fails
[2025-11-11T15:27:48.965Z] [PIPELINE] Starting AI pipeline orchestration
[2025-11-11T15:27:48.965Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

stderr | test/pipeline.spec.ts > Error Handling > should skip Stage 3 if Stage 2 fails
[SANITIZER] Failed to extract JSON: Error: No JSON object or array found in response
    at extractFirstJSON (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:98:9)
    at sanitizeAIResponse (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/sanitizers.ts:171:13)
    at parseUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/validation/parsers.ts:26:20)
    at runUsageSummary (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:138:37)
    at withTimeout (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:384:18)
    at withRetry (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/lib/retry.ts:69:19)
    at runPipeline (/Users/abdul/Downloads/Projects/EnergyGenius/src/worker/pipeline.ts:249:18)
    at /Users/abdul/Downloads/Projects/EnergyGenius/test/pipeline.spec.ts:376:18
    at Users/abdul/Downloads/Projects/EnergyGenius/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
[2025-11-11T15:27:48.966Z] [PARSE] [USAGE-SUMMARY] Failed to parse JSON response: Unexpected token 'M', "Mock" is not valid JSON

stdout | test/pipeline.spec.ts > Error Handling > should skip Stage 3 if Stage 2 fails
[2025-11-11T15:27:48.966Z] [PARSE] [USAGE-SUMMARY] Raw response (first 500 chars): Mock

stdout | test/pipeline.spec.ts > Error Handling > should skip Stage 3 if Stage 2 fails
[2025-11-11T15:27:48.966Z] [RETRY] [USAGE-SUMMARY] Attempt 1/2 failed: Failed to parse JSON response: Unexpected token 'M', "Mock" is not valid JSON (retriable: false)

stdout | test/pipeline.spec.ts > Error Handling > should skip Stage 3 if Stage 2 fails
[2025-11-11T15:27:48.966Z] [FALLBACK] Using calculated usage summary fallback
[2025-11-11T15:27:48.966Z] [PLAN-SCORING] [RUNNING] Input size: 274 bytes

stderr | test/pipeline.spec.ts > Error Handling > should skip Stage 3 if Stage 2 fails
[2025-11-11T15:27:48.966Z] [USAGE_SUMMARY] [ERROR] Failed to parse JSON response: Unexpected token 'M', "Mock" is not valid JSON

stdout | test/pipeline.spec.ts > Error Handling > should skip Stage 3 if Stage 2 fails
[2025-11-11T15:27:48.966Z] [RETRY] [PLAN-SCORING] Attempt 1/2 failed: Stage 2 failed (retriable: false)

stdout | test/pipeline.spec.ts > Error Handling > should skip Stage 3 if Stage 2 fails
[2025-11-11T15:27:48.966Z] [FALLBACK] Using neutral plan scoring fallback
[2025-11-11T15:27:48.966Z] [NARRATIVE] [RUNNING] Input size: 1466 bytes

stderr | test/pipeline.spec.ts > Error Handling > should skip Stage 3 if Stage 2 fails
[2025-11-11T15:27:48.966Z] [PLAN_SCORING] [ERROR] Stage 2 failed

stdout | test/pipeline.spec.ts > Error Handling > should skip Stage 3 if Stage 2 fails
[2025-11-11T15:27:48.966Z] [PARSE] [NARRATIVE] Raw response (first 500 chars): Mock

stderr | test/pipeline.spec.ts > Error Handling > should skip Stage 3 if Stage 2 fails
[2025-11-11T15:27:48.966Z] [PARSE] [NARRATIVE] Response too short: 4 chars, expected at least 200

stdout | test/pipeline.spec.ts > Error Handling > should skip Stage 3 if Stage 2 fails
[2025-11-11T15:27:48.967Z] [RETRY] [NARRATIVE] Attempt 1/2 failed: Response too short: 4 chars, expected at least 200 (retriable: false)

stdout | test/pipeline.spec.ts > Error Handling > should skip Stage 3 if Stage 2 fails
[2025-11-11T15:27:48.967Z] [FALLBACK] Using generic narrative fallback
[2025-11-11T15:27:48.967Z] [PIPELINE] Pipeline completed in 2ms with 3 errors

stderr | test/pipeline.spec.ts > Error Handling > should skip Stage 3 if Stage 2 fails
[2025-11-11T15:27:48.967Z] [NARRATIVE] [ERROR] Response too short: 4 chars, expected at least 200

stdout | test/pipeline.spec.ts > Timeout Handling > should timeout if stage exceeds 30 seconds
[2025-11-11T15:27:48.976Z] [PIPELINE] Starting AI pipeline orchestration
[2025-11-11T15:27:48.976Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

stdout | test/pipeline.spec.ts > Timeout Handling > should timeout if stage exceeds 30 seconds
[2025-11-11T15:28:18.979Z] [RETRY] [USAGE-SUMMARY] Attempt 1/2 failed: Stage usage-summary exceeded 30s timeout (retriable: true)
[2025-11-11T15:28:18.980Z] [RETRY] [USAGE-SUMMARY] Waiting 100ms before retry...

stdout | test/pipeline.spec.ts > Timeout Handling > should timeout if stage exceeds 30 seconds
[2025-11-11T15:28:19.075Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

stdout | test/pipeline.spec.ts > Timeout Handling > should include stage name in timeout error message
[2025-11-11T15:28:23.987Z] [PIPELINE] Starting AI pipeline orchestration
[2025-11-11T15:28:23.987Z] [USAGE-SUMMARY] [RUNNING] Input size: 801 bytes

