# Story 10.5: Display kWh Rate and Monthly Fee in UI

**Epic:** Epic 10 - Critical Production Bugs
**Status:** Ready for Development
**Priority:** P1 - High (UX/Transparency)
**Complexity:** Low
**Owner:** Dev Team

---

## User Story

As a user reviewing energy plan recommendations, I need to see the price per kWh and monthly service fee for each plan so that I can compare pricing across plans and make informed decisions.

---

## Problem Statement

**UX ISSUE CONFIRMED BY INVESTIGATION 10.2**

Currently, the recommendation cards show only the estimated monthly cost (calculated as annual cost / 12). Users cannot see:
- **Base rate (price per kWh)** - The most important comparison metric
- **Monthly service fee** - A hidden cost component

This prevents users from understanding how costs are structured and comparing plans fairly.

### What Users Currently See:

```
┌─────────────────────────────┐
│ Reliant Energy              │
│ Simple Rate 12              │
│ Annual Savings: $214/year   │
│ Monthly Cost: $109/month    │ ← Derived from annual ÷ 12
│ Contract: 12 months         │
│ Early Termination: $0       │
│ Renewable: 15%              │
└─────────────────────────────┘
```

### What Users Need to See:

```
┌─────────────────────────────┐
│ Reliant Energy              │
│ Simple Rate 12              │
│                             │
│ Base Rate: $0.095/kWh  ← ADD THIS (THE KEY COMPARISON)
│ Monthly Fee: $9.95     ← ADD THIS (transparency)
│ Estimated Monthly: $109 ← Keep
│                             │
│ Annual Savings: $214/year   │
│ Contract: 12 months         │
│ Early Termination: $0       │
│ Renewable: 15%              │
└─────────────────────────────┘
```

### Why This Matters:

- **Fair comparison**: Users can compare price per kWh across all plans
- **Transparency**: Monthly fee not hidden in total cost
- **Empowerment**: Users understand cost structure and can do their own math
- **Trust**: Shows all numbers, not just derived results

### Evidence from Investigation 10.2 (AC6):

```
Finding: kWh Rate Not Displayed

Current Data Flow:
✓ Backend has baseRate in SupplierPlan catalog
✓ baseRate available in recommendation database
✗ baseRate NOT included in API response
✗ baseRate NOT passed to frontend
✗ baseRate NOT displayed in UI

Similar issue with monthlyFee:
✓ monthlyFee in catalog
✗ monthlyFee NOT in API response
✗ monthlyFee NOT in frontend
✗ monthlyFee NOT visible to users

Root cause: Data exists but not passed through architecture layers
Fix: Include fields in response and display in UI (simple!)
```

---

## Acceptance Criteria

### 1. Add Fields to API Response

**File:** `src/worker/handlers/recommend.ts`

**Current Implementation (lines 152-160):**
```typescript
return {
  ...plan,
  rationale: null,
  renewablePercent: catalogPlan?.renewablePercent ?? 0,
  contractTermMonths: catalogPlan?.contractTermMonths ?? 12,
  earlyTerminationFee: catalogPlan?.earlyTerminationFee ?? 0,
  // ❌ baseRate missing
  // ❌ monthlyFee missing
};
```

**Required Changes:**
- [ ] Add `baseRate` field to recommendation response
  ```typescript
  baseRate: catalogPlan?.baseRate ?? 0,
  ```
- [ ] Add `monthlyFee` field to recommendation response
  ```typescript
  monthlyFee: catalogPlan?.monthlyFee ?? 0,
  ```
- [ ] Ensure fields are populated from `catalogPlan`
- [ ] If `catalogPlan` not found, use sensible defaults (0, not undefined)

**Updated Response:**
```typescript
return {
  ...plan,
  rationale: null,
  renewablePercent: catalogPlan?.renewablePercent ?? 0,
  contractTermMonths: catalogPlan?.contractTermMonths ?? 12,
  earlyTerminationFee: catalogPlan?.earlyTerminationFee ?? 0,
  baseRate: catalogPlan?.baseRate ?? 0,        // ← ADD THIS
  monthlyFee: catalogPlan?.monthlyFee ?? 0,    // ← ADD THIS
};
```

### 2. Update Frontend Type Definitions

**File:** `src/ui/context/types.ts` (or wherever Recommendation type is defined)

**Current Type:**
```typescript
interface Recommendation {
  planId: string;
  estimatedAnnualCost: number;
  estimatedSavings: number;
  // ... other fields
  // ❌ baseRate missing
  // ❌ monthlyFee missing
}
```

**Required Changes:**
- [ ] Add `baseRate?: number` to Recommendation interface
- [ ] Add `monthlyFee?: number` to Recommendation interface
- [ ] Make them optional (?) to handle backward compatibility if needed
- [ ] Document in comments: "baseRate: $/kWh, monthlyFee: $/month"

**Updated Type:**
```typescript
interface Recommendation {
  planId: string;
  estimatedAnnualCost: number;
  estimatedSavings: number;
  // ... existing fields
  baseRate?: number;        // ← ADD THIS (price per kWh)
  monthlyFee?: number;      // ← ADD THIS (monthly service charge)
}
```

### 3. Update RecommendationDeck Component to Display Fields

**File:** `src/ui/components/results/RecommendationDeck.tsx`

**Location:** In the recommendation card where pricing information is displayed

**Current Implementation (around lines 240-250):**
```tsx
<span className="font-bold text-lg text-gray-900">
  ${recommendation.monthlyPrice.toFixed(2)}
</span>
```

**Required Changes:**
- [ ] Create a pricing section above or near the monthly cost
- [ ] Display baseRate with 3 decimal places (standard for electricity rates)
  ```tsx
  <div className="text-sm text-gray-600">
    Base Rate: <span className="font-semibold text-gray-900">${recommendation.baseRate?.toFixed(3)}/kWh</span>
  </div>
  ```
- [ ] Display monthlyFee with 2 decimal places
  ```tsx
  <div className="text-sm text-gray-600">
    Monthly Fee: <span className="font-semibold text-gray-900">${recommendation.monthlyFee?.toFixed(2)}</span>
  </div>
  ```
- [ ] Keep existing monthly cost display (for reference)
- [ ] Optionally add a divider line between pricing components

**Suggested Layout:**
```tsx
{/* Pricing Summary Section */}
<div className="space-y-1 border-t pt-2 mt-2">
  <div className="flex justify-between text-sm">
    <span className="text-gray-600">Price per kWh:</span>
    <span className="font-semibold text-gray-900">
      ${recommendation.baseRate?.toFixed(3)}/kWh
    </span>
  </div>
  <div className="flex justify-between text-sm">
    <span className="text-gray-600">Monthly Service Fee:</span>
    <span className="font-semibold text-gray-900">
      ${recommendation.monthlyFee?.toFixed(2)}
    </span>
  </div>
  <div className="flex justify-between text-sm border-t pt-1 mt-1">
    <span className="text-gray-600">Est. Monthly Cost:</span>
    <span className="font-bold text-gray-900">
      ${recommendation.monthlyPrice?.toFixed(2)}
    </span>
  </div>
</div>
```

### 4. Handle Missing Data Gracefully

**File:** `src/ui/components/results/RecommendationDeck.tsx`

- [ ] If `baseRate` is missing or 0, show "—" or "N/A" instead of "$0.000/kWh"
- [ ] If `monthlyFee` is missing or 0, show "$0.00" (valid, some plans have no fee)
- [ ] Add fallback for undefined values:
  ```tsx
  ${(recommendation.baseRate ?? 0).toFixed(3)}/kWh
  ${(recommendation.monthlyFee ?? 0).toFixed(2)}
  ```
- [ ] No console errors if fields are missing

### 5. Verify Calculation Transparency

**Optional Enhancement:**
- [ ] Consider adding a small note explaining the calculation
  ```
  "Monthly Cost = (kWh Usage × Base Rate) + Monthly Fee"
  ```
- [ ] Can go in a tooltip or expandable "How is this calculated?" section
- [ ] Not required for this story, but improves transparency

### 6. Testing & Verification

**Unit Tests:**
- [ ] Recommendation with both baseRate and monthlyFee displays correctly
- [ ] Recommendation with missing baseRate shows gracefully
- [ ] Values format correctly (3 decimals for rate, 2 for fee)

**Manual Testing:**
- [ ] Generate recommendations
- [ ] Verify each card shows Base Rate and Monthly Fee
- [ ] Verify values are correct (compare to catalog data)
- [ ] Verify formatting is consistent across cards
- [ ] No console errors or undefined values in UI
- [ ] Layout looks clean and readable

**Regression Testing:**
- [ ] Existing recommendation display still works
- [ ] Savings amounts still display correctly
- [ ] Other card elements unaffected
- [ ] Responsive layout preserved on mobile/tablet

---

## Implementation Notes

### Data Validation Before Display

The `baseRate` and `monthlyFee` come from `supplierCatalog`. Per investigation 10.2:
- **baseRate**: 64 unique values, range $0.108-$0.191 (realistic)
- **monthlyFee**: Currently all $9.95 (BUG - story 10.3 fixes this)

Once story 10.3 is complete, monthlyFee will have realistic variation.

**For now:**
- Display whatever values are in the recommendation object
- Story 10.3 will provide accurate data
- This story is just the display layer

### Decimal Place Conventions

- **Base Rate**: 3 decimal places (`$0.095/kWh`)
  - Industry standard for electricity rates
  - Matches how users see rates on powertochoose.org

- **Monthly Fee**: 2 decimal places (`$9.95`)
  - Standard currency formatting
  - Matches other dollar amounts in UI

- **Monthly Cost**: 2 decimal places (`$109.24`)
  - Already exists, keep as-is

### Styling Consistency

- Use existing typography classes from recommendation card
- Keep font sizes consistent with other pricing information
- Consider grouping in a "Pricing Details" section for clarity
- Use border or spacing to separate from other card sections

---

## Tasks / Subtasks

- [ ] Add baseRate and monthlyFee fields to recommend.ts response
- [ ] Update Recommendation type definition to include new fields
- [ ] Add pricing display section to RecommendationDeck component
- [ ] Handle missing data gracefully with fallbacks
- [ ] Test with sample recommendations
- [ ] Verify formatting and layout
- [ ] Ensure no console errors
- [ ] Build and verify no regressions

---

## Dev Notes

### Why This Is P1 (High Priority)

**Severity**: UX/Transparency Issue
- Users cannot see price per kWh (most important metric)
- Monthly fee hidden in aggregated cost
- Prevents fair plan comparison

**Ease of Fix**: Very Simple
- Data already exists in API
- Just need to add 2 fields to response
- Display in UI (5-10 lines of code)

**Impact**: Moderate
- Improves user trust and understanding
- Enables better decision-making
- Data transparency = user confidence

**Urgency**: Can wait for 10.3 and 10.4 to complete first
- Those are P0 critical data/calculation issues
- This is UX polish that depends on correct data from 10.3

### Related Stories

- **Story 10.3** (Fix Monthly Fee Data): Provides accurate monthlyFee data
- **Story 10.2** (Investigation): Identified this as AC6 finding
- **Story 10.1** (Blank Page Crash): Different issue (parser/React)
- **Story 10.4** (Move Calculations): Independent (calculation architecture)

---

## Change Log

**2025-11-12 - Story Created by SM**
- Created based on investigation story 10.2 findings (AC6: kWh Rate Display)
- UX issue identified: baseRate and monthlyFee not displayed to users
- Solution: Add 2 fields to API response, display in recommendation cards
- Simple implementation: ~20 lines total code changes
- Priority: P1 - HIGH (UX/Transparency)
- Complexity: LOW (straightforward data pass-through and display)
- Status: Ready for Development
- Can be implemented in parallel with 10.3 and 10.4 (independent changes)

