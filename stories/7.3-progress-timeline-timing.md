# Story 7.3: Fix Progress Timeline Timing Issue

**Epic:** Epic 7 - Post-Launch Improvements
**Status:** Ready for Development
**Priority:** P1 - Critical UX Issue
**Complexity:** Medium
**Owner:** Dev Team

---

## User Story

As a user, I want the progress timeline UI to accurately reflect the actual state of the recommendation process, so that when it shows "success" I'm not left waiting another 50 seconds wondering if something is wrong.

---

## Acceptance Criteria

### Investigate Progress Timeline Timing

- [ ] Review progress timeline component implementation:
  - [ ] Examine `/src/ui/components/ProgressTimeline.tsx`
  - [ ] Check how progress states are updated
  - [ ] Verify what triggers "success" state at 10s mark
- [ ] Review AI pipeline orchestration:
  - [ ] Check `/src/worker/ai/orchestration.ts`
  - [ ] Identify all stages and their timing
  - [ ] Check where SSE events are emitted
  - [ ] Verify order and timing of events
- [ ] Review API integration:
  - [ ] Check `/src/ui/hooks/useRecommendation.ts`
  - [ ] Verify how API response completion is detected
  - [ ] Check timeout handling
  - [ ] Identify mismatch between UI success and API completion
- [ ] Document timeline expectations:
  - [ ] Worker processing stages and their durations
  - [ ] SSE event emission timing
  - [ ] Expected total time from start to finish
  - [ ] Current mismatch: UI success at 10s, actual at 60s

### Identify Root Cause

- [ ] Analyze timing data:
  - [ ] Add instrumentation to log each stage:
    - [ ] Prompt building time
    - [ ] Model inference start time
    - [ ] Model inference end time
    - [ ] Response parsing time
    - [ ] SSE stream completion time
  - [ ] Log timing for 5+ test runs
  - [ ] Identify which stage is causing delay
- [ ] Check SSE streaming implementation:
  - [ ] Verify SSE is correctly streaming chunks
  - [ ] Check if all chunks are being sent
  - [ ] Verify no buffering or delays in streaming
  - [ ] Confirm client receives chunks in real-time
- [ ] Review progress update logic:
  - [ ] What event triggers "Building Recommendation" → "Complete"?
  - [ ] Is it immediate, or waiting for something?
  - [ ] Should it transition to "Complete" when model inference starts? Ends? Stream finishes?
- [ ] Document root cause findings

### Fix Progress Timeline Logic

- [ ] Determine correct timeline stages (e.g.):
  - Stage 1: "Analyzing Input" (0-2s) → Intake form processing
  - Stage 2: "Preparing Request" (2-5s) → Prompt building
  - Stage 3: "Thinking..." (5-40s) → AI model inference
  - Stage 4: "Generating Output" (40-55s) → Response parsing/formatting
  - Stage 5: "Complete" (55s+) → All done, results available
- [ ] Options for fixing:
  - Option A: Show realistic timing (60s is accurate)
    - Update progress markers to show 55-60s for "Complete"
    - Update UI expectations messaging
    - Keep actual completion time visible
  - Option B: Optimize worker (Story 7.1) to actually finish in 20s
    - This is the preferred approach (tie to Story 7.1)
    - After 7.1 completes, results should show at appropriate time
  - Option C: Show "streaming results" state while waiting for full completion
    - Partial results available, but more coming
    - Don't mark complete until truly done
- [ ] Recommend approach and document rationale
- [ ] Implement chosen approach

### Update Progress Timeline Component

- [ ] Modify `/src/ui/components/ProgressTimeline.tsx`:
  - [ ] Add/update progress stages to match actual flow
  - [ ] Update duration estimates if needed
  - [ ] Ensure "Complete" is only shown when truly complete
  - [ ] Consider visual indicator for "in progress" vs "complete" states
  - [ ] Add proper TypeScript types for progress states
- [ ] Ensure accurate timing:
  - [ ] Each stage timestamp accurately reflects worker events
  - [ ] No premature "complete" state
  - [ ] Clear indication while still processing
- [ ] Test with performance monitoring:
  - [ ] Run 5+ test submissions
  - [ ] Verify progress markers match actual timing
  - [ ] Verify no misleading "complete" before results available

### Update Worker Instrumentation

- [ ] Add comprehensive timing to `/src/worker/index.ts`:
  - [ ] Log stage entry/exit timestamps
  - [ ] Include timing metadata in SSE events:
    - [ ] Current stage
    - [ ] Stage start time
    - [ ] Elapsed time
    - [ ] Estimated time remaining
  - [ ] Send timing info to frontend in response
  - [ ] Log to console for debugging
- [ ] Update SSE event format:
  - [ ] Include stage information
  - [ ] Include timing data
  - [ ] Ensure frontend can parse timing
- [ ] Test logging:
  - [ ] Verify console shows all timing events
  - [ ] Confirm timing is accurate
  - [ ] Check for any spurious events

### Integration with Story 7.1

- [ ] Coordinate with Story 7.1 (Model Performance):
  - [ ] If 7.1 succeeds, worker time will be ~20s instead of ~60s
  - [ ] Timeline will naturally be more accurate
  - [ ] Both stories together solve the performance + UX issue
- [ ] After 7.1 completes:
  - [ ] Timeline should show completion near 15-20s
  - [ ] No more mysterious 50s wait time
  - [ ] User experience significantly improved

### Code & Documentation

- [ ] Update `/src/ui/components/ProgressTimeline.tsx`:
  - [ ] Fix progress stage logic
  - [ ] Update timing references
  - [ ] Add TypeScript types
  - [ ] Add code comments explaining timeline
- [ ] Update `/src/worker/index.ts`:
  - [ ] Add timing instrumentation
  - [ ] Include timing in SSE events
  - [ ] Include timing in final response
- [ ] Update `/docs/architecture.md`:
  - [ ] Document progress timeline stages
  - [ ] Explain timing expectations
  - [ ] Note relationship to Story 7.1
  - [ ] Include timeline diagram (if helpful)
- [ ] Commit with message: "Fix progress timeline to accurately reflect recommendation timing"

## Tasks / Subtasks

- [ ] Investigate Timing Issue (AC: Investigate Progress Timeline Timing)
  - [ ] Review progress timeline component
  - [ ] Review AI orchestration
  - [ ] Review API integration
  - [ ] Document mismatch
- [ ] Identify Root Cause (AC: Identify Root Cause)
  - [ ] Add timing instrumentation
  - [ ] Analyze results
  - [ ] Check SSE streaming
  - [ ] Document findings
- [ ] Determine Fix Strategy (AC: Fix Progress Timeline Logic)
  - [ ] Analyze timing stages
  - [ ] Decide on fix approach
  - [ ] Document rationale
- [ ] Implement Timeline Fix (AC: Update Progress Timeline Component)
  - [ ] Fix progress stages
  - [ ] Update timing logic
  - [ ] Test with real submissions
- [ ] Add Worker Instrumentation (AC: Update Worker Instrumentation)
  - [ ] Add comprehensive logging
  - [ ] Update SSE events
  - [ ] Test logging
- [ ] Coordinate with 7.1 (AC: Integration with Story 7.1)
  - [ ] Understand 7.1 impact
  - [ ] Plan integration
  - [ ] Note dependencies
- [ ] Documentation & Commit (AC: Code & Documentation)
  - [ ] Update component code
  - [ ] Update worker code
  - [ ] Update documentation
  - [ ] Commit changes

## Dev Notes

- Current behavior: Progress shows "Complete" ~10s into a ~60s process
- This creates poor UX: user thinks it's done but has to wait 50+ more seconds
- Root cause likely one of:
  - Progress state incorrectly transitions to "complete"
  - Timing mismatch between worker progress and UI display
  - SSE streaming vs. promise completion misalignment
- Story 7.1 (Model Optimization) is complementary:
  - If worker time reduced to 20s, timeline naturally becomes more accurate
  - Both stories together solve the full problem
- Proposed fix strategy:
  1. Investigate to find actual root cause (is it worker logic or UI logic?)
  2. Fix progress state transitions
  3. Add comprehensive timing instrumentation
  4. Test that progress now accurately reflects actual progress
  5. Story 7.1 will naturally improve timing by reducing worker time

### Project Structure Notes

- Progress timeline: `/src/ui/components/ProgressTimeline.tsx` [Source: story-5.2]
- API hook: `/src/ui/hooks/useRecommendation.ts` [Source: story-5.4]
- Worker orchestration: `/src/worker/ai/orchestration.ts` [Source: story-3.1]
- Worker entry point: `/src/worker/index.ts` [Source: story-1.4]

### References

- [Source: stories/5.2-progress-timeline-component.md]
- [Source: stories/5.4-api-integration-hook.md]
- [Source: stories/3.1-ai-pipeline-orchestration.md]
- [Source: stories/1.4-worker-entry-point.md]
- Related: [Story 7.1 - Workers AI Model Performance Investigation]

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

Claude Haiku 4.5

### Debug Log References

### Completion Notes List

### File List
