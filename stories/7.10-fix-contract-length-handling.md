# Story 7.10: Fix Contract Length Handling

**Epic:** Epic 7 - Post-Launch Improvements
**Status:** Ready for Development
**Priority:** P1 - High
**Complexity:** Medium
**Owner:** Dev Team

---

## User Story

As a user, I should be able to see and specify contract length preferences, and recommendations should respect contract length requirements. Currently, the system has an arbitrary 24-month limit that needs investigation and fixing.

---

## Acceptance Criteria

### 1. Investigate Contract Length Implementation

- [ ] Understand current contract length handling:
  - [ ] Where is the 24-month limit imposed? (backend logic, frontend, both?)
  - [ ] File locations: Search for "24" or "contract" in codebase
  - [ ] Is the limit enforced in:
    - [ ] Plan data model?
    - [ ] Recommendation prompt?
    - [ ] UI input validation?
    - [ ] Database/storage?

- [ ] Document current behavior:
  - [ ] What is the contract length range in UI?
  - [ ] What happens if user requests > 24 months?
  - [ ] Are there actual plans with > 24 months?
  - [ ] Is 24-month limit used in recommendations?

- [ ] Find the 24-month limit:
  - [ ] Search codebase: `24`, `months`, `contract`, `duration`
  - [ ] Check validation logic
  - [ ] Check prompt construction
  - [ ] Check plan data definitions
  - [ ] Document all locations where limit appears

- [ ] Understand why the limit exists:
  - [ ] Is it intentional design decision?
  - [ ] Is it arbitrary/leftover from development?
  - [ ] Is it a business constraint?
  - [ ] Is it a technical limitation?
  - [ ] Document findings

- [ ] Developer has full authority to investigate and modify

### 2. Determine Correct Contract Length Range

- [ ] Research real energy plans:
  - [ ] What contract lengths do real suppliers offer?
  - [ ] Typical ranges: 1 month to 36+ months?
  - [ ] Are there longer-term contracts (2-3 years)?
  - [ ] Do any suppliers offer custom lengths?

- [ ] Review current data:
  - [ ] What contract lengths exist in mock data?
  - [ ] What lengths do scraped plans have (if scraper exists)?
  - [ ] Document actual range in current data

- [ ] Decide on acceptable range:
  - [ ] Minimum: 1 month? 3 months?
  - [ ] Maximum: 24 months? 36 months? 60 months? Unlimited?
  - [ ] Should match real plans available
  - [ ] Should be flexible for future expansion

- [ ] Document the decision:
  - [ ] Why these limits were chosen
  - [ ] How this aligns with business/user needs
  - [ ] Update comments/docs with rationale

### 3. Remove or Fix the 24-Month Limit

**Option A: Remove Limit Entirely**
- [ ] If 24-month limit is arbitrary:
  - [ ] Remove hard-coded 24-month constraint
  - [ ] Allow any reasonable contract length
  - [ ] Minimum validation: > 0 months
  - [ ] Maximum validation: < 1000 months (safety check)

**Option B: Set Appropriate Limit**
- [ ] If limit needs to exist:
  - [ ] Change to realistic maximum (e.g., 36 months)
  - [ ] Document why this limit was chosen
  - [ ] Add comment: "Contracts up to X months supported"
  - [ ] Ensure this matches actual available plans

**Option C: Make Limit Configurable**
- [ ] If business wants to control this:
  - [ ] Add configuration option: `MAX_CONTRACT_MONTHS`
  - [ ] Load from environment or config file
  - [ ] Allow changing without code update

- [ ] Fix all locations:
  - [ ] UI validation (input max value)
  - [ ] Prompt/context (include actual limits)
  - [ ] Recommendation logic (consider all lengths)
  - [ ] Plan data (support any realistic length)
  - [ ] Database/storage (handle any length)

### 4. Ensure Contract Length Used in Recommendations

- [ ] Verify contract length is included in prompts:
  - [ ] Is user's preferred contract length sent to Claude?
  - [ ] Is contract length of plans included in context?
  - [ ] Does Claude consider contract length when recommending?

- [ ] Update prompt if needed:
  - [ ] Include contract length in user preferences section
  - [ ] Include contract length for each plan in context
  - [ ] Add instruction: "Consider contract length in your recommendations"
  - [ ] Example: "User prefers 12-month contract, so prioritize plans with 12-month options"

- [ ] Update recommendation handler:
  - [ ] File: `/src/worker/ai/recommendation-handler.ts`
  - [ ] Include contract length in context sent to Claude
  - [ ] Add contract length to plan data in prompt
  - [ ] Log what contract length context is sent

- [ ] Verify contract length is returned:
  - [ ] Does Claude include contract length in response?
  - [ ] Is it displayed in recommendations?
  - [ ] Does UI show "12-month contract" etc.?

### 5. Update UI Components

- [ ] Fix input component:
  - [ ] File: Wherever user selects contract length (likely results page)
  - [ ] Change max value from 24 to new limit
  - [ ] Update validation message
  - [ ] Update tooltip/help text
  - [ ] Example: "Select contract length (1-36 months)"

- [ ] Update UI validation:
  - [ ] Min value validation
  - [ ] Max value validation
  - [ ] Clear error messages
  - [ ] No hardcoded 24

- [ ] Update display in recommendations:
  - [ ] Show contract length clearly for each plan
  - [ ] Format nicely: "12 months" or "1 year"
  - [ ] Include in plan summary
  - [ ] Use in recommendation reasoning

### 6. Update Plan Data

- [ ] Audit plan data:
  - [ ] File: `/src/worker/data/suppliers.ts`
  - [ ] Verify all plans have contract length
  - [ ] Verify contract lengths are realistic
  - [ ] Add any missing contract length information

- [ ] Example plan structure:
  ```typescript
  {
    supplier: "GreenEnergy Inc",
    plans: [
      {
        name: "Basic",
        pricePerKwh: 0.125,
        contractMonths: 12,  // Ensure this is present and correct
        // ... other fields
      },
      {
        name: "Premium",
        pricePerKwh: 0.145,
        contractMonths: 24,  // Can be any reasonable value
        // ... other fields
      }
    ]
  }
  ```

### 7. Testing

- [ ] Unit tests:
  - [ ] Contract length validation works
  - [ ] No hard-coded 24-month limit
  - [ ] Proper min/max handling
  - [ ] Edge cases (0 months, 1000 months)

- [ ] Integration tests:
  - [ ] Generate recommendations with various contract lengths
  - [ ] Verify Claude considers contract length
  - [ ] Verify returned plans have correct contract length
  - [ ] Test edge cases

- [ ] Manual testing:
  - [ ] Run dev server
  - [ ] Try selecting different contract lengths
  - [ ] Generate recommendations
  - [ ] Verify:
    - [ ] All contract lengths work
    - [ ] Recommendations consider contract preference
    - [ ] Displayed contract lengths are correct
    - [ ] No validation errors for reasonable values

- [ ] Regression testing:
  - [ ] Everything else still works
  - [ ] No new errors
  - [ ] Performance is acceptable

### 8. Documentation

- [ ] Update developer docs:
  - [ ] Document contract length range
  - [ ] Document why this range was chosen
  - [ ] Add to `/docs/development.md` or `/docs/data.md`
  - [ ] Include example of contract length in plan data

- [ ] Add code comments:
  - [ ] Explain contract length validation
  - [ ] Explain why certain limits exist
  - [ ] Reference this story if changed for a reason

- [ ] Update user-facing help:
  - [ ] Update any tooltips
  - [ ] Update help text
  - [ ] Explain what contract length means
  - [ ] Example: "A 12-month contract locks you in for 1 year"

- [ ] Commit message: "Fix contract length handling - Remove arbitrary 24-month limit, ensure contract length used in recommendations"

## Tasks / Subtasks

- [ ] Investigate Limit (AC: Investigate Contract Length Implementation)
  - [ ] Find where 24-month limit is enforced
  - [ ] Search codebase
  - [ ] Document all locations
  - [ ] Understand why it exists

- [ ] Determine Range (AC: Determine Correct Contract Length Range)
  - [ ] Research real plans
  - [ ] Review current data
  - [ ] Decide on acceptable range
  - [ ] Document decision and rationale

- [ ] Remove/Fix Limit (AC: Remove or Fix the 24-Month Limit)
  - [ ] Remove or change hard-coded limit
  - [ ] Update all affected locations
  - [ ] Add appropriate validation
  - [ ] Test thoroughly

- [ ] Use in Recommendations (AC: Ensure Contract Length Used in Recommendations)
  - [ ] Verify it's in prompts
  - [ ] Update prompts if needed
  - [ ] Verify it's in returned recommendations
  - [ ] Test end-to-end

- [ ] Update UI (AC: Update UI Components)
  - [ ] Fix input max value
  - [ ] Fix validation messages
  - [ ] Update display
  - [ ] Test UI changes

- [ ] Update Data (AC: Update Plan Data)
  - [ ] Verify all plans have contract length
  - [ ] Add missing lengths
  - [ ] Verify lengths are realistic
  - [ ] Document structure

- [ ] Test (AC: Testing)
  - [ ] Unit tests
  - [ ] Integration tests
  - [ ] Manual testing
  - [ ] Regression testing

- [ ] Document (AC: Documentation)
  - [ ] Update developer docs
  - [ ] Add code comments
  - [ ] Update help text
  - [ ] Commit changes

## Dev Notes

### Investigation Authority

Developer has full authority to:
- Change contract length limits
- Modify plan data
- Update prompts
- Change UI validation
- Modify recommendation logic
- Research and decide on appropriate ranges

### Finding the 24-Month Limit

Search commands:
```bash
# Search for "24" in context of months/contract
grep -r "24" /src --include="*.ts" --include="*.tsx" | grep -i "month\|contract"

# Search for max contract
grep -r "max.*contract\|contract.*max" /src --include="*.ts" --include="*.tsx"

# Look for validation limits
grep -r "maxLength\|max:\|maximum:" /src --include="*.ts" --include="*.tsx" | grep -i "contract\|month"
```

### Common Locations for Limit

- **UI Input**: `<input type="range" max="24" />` or `maxLength: 24`
- **Validation**: `if (months > 24) throw Error(...)`
- **Prompt**: `"Contract length: up to 24 months"`
- **Plan Data**: `contractMonths: 12` or `24`
- **API/Routes**: Validation in backend endpoints

### Real-World Contract Lengths

Common ranges:
- Monthly: 1 month
- Short-term: 3, 6 months
- Standard: 12 months (1 year)
- Long-term: 24 months (2 years), 36 months (3 years)
- Very long: 60 months (5 years) or more

Most common: 12 and 24 months
Some plans: 1-3 months, 6 months, 36 months

### Example Fix

**BEFORE:**
```typescript
// Hard-coded limit - wrong!
const maxContractMonths = 24;

// In prompt
"Contract length up to 24 months"

// In UI
<input type="range" min="1" max="24" />
```

**AFTER:**
```typescript
// Configurable or removed
const maxContractMonths = 60; // or remove limit entirely

// In prompt
"Include actual contract lengths for each plan"

// In UI
<input type="range" min="1" max="60" />

// In plan data
{ name: "Plan", contractMonths: 12 }
{ name: "Plan", contractMonths: 24 }
{ name: "Plan", contractMonths: 36 }
```

### Verification Checklist

After fix, verify:
- [ ] Limit is removed or documented
- [ ] UI accepts all realistic contract lengths
- [ ] Validation allows reasonable values
- [ ] Plans have correct contract lengths
- [ ] Claude uses contract length in recommendations
- [ ] Contract length is displayed to users
- [ ] No validation errors for valid inputs
- [ ] Tests pass
- [ ] Documentation updated

## Dev Agent Record

### Context Reference

<!-- Story context XML will be added here by context workflow -->

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

### Completion Notes List

<!-- To be filled in during development -->

## QA Checklist

- [ ] 24-month limit removed or documented
- [ ] All locations updated (UI, validation, prompts, data)
- [ ] Contract lengths in data are realistic
- [ ] UI accepts all valid contract lengths
- [ ] Recommendations consider contract length
- [ ] Contract length displayed in recommendations
- [ ] No validation errors for valid input
- [ ] Tests pass
- [ ] Documentation updated
- [ ] Changes committed
