# Story 1.1: Project Scaffold & Toolchain Setup

**Epic:** Epic 1 - Project Setup & Infrastructure
**Status:** Done
**Priority:** P0 - Critical Path
**Complexity:** Medium
**Owner:** Dev Team

---

## User Story

As a developer, I need to bootstrap the Cloudflare Workers + React project with TypeScript tooling and build configuration so that the team has a working development environment ready for feature implementation.

---

## Acceptance Criteria

### Project Initialization

- [x] Run `npm create cloudflare@latest energy-genius` selecting the base Worker template
- [x] Confirm initial scaffolding includes Wrangler CLI, Vite, and package.json
- [x] Verify no TypeScript or build errors after initial setup
- [x] Commit initial scaffolding state to git

### React & Dependencies Installation

- [x] Install React and React DOM: `npm install react react-dom`
- [x] Install Vite plugin for React: `npm install -D @vitejs/plugin-react`
- [x] Install Cloudflare Workers types: `npm install -D @cloudflare/workers-types`
- [x] Install TypeScript if not already included: `npm install -D typescript`
- [x] Verify all dependencies in package.json

### TypeScript Configuration

- [x] Create `tsconfig.json` as root config with project references
- [x] Create `tsconfig.worker.json` for Workers runtime:
  - [x] `"target": "ES2022"`
  - [x] `"lib": ["ES2022"]` (no DOM libs)
  - [x] `"types": ["@cloudflare/workers-types"]`
  - [x] Include `src/worker/**/*`
- [x] Create `tsconfig.ui.json` for React:
  - [x] `"target": "ES2020"`
  - [x] `"lib": ["ES2020", "DOM", "DOM.Iterable"]`
  - [x] JSX support: `"jsx": "react-jsx"`
  - [x] Include `src/ui/**/*`
- [x] Verify TypeScript strict mode enabled in root tsconfig
- [x] Compile both configs without errors: `npx tsc -p tsconfig.worker.json` and `npx tsc -p tsconfig.ui.json`

### Vite Configuration

- [x] Create `vite.config.ts`:

  ```typescript
  import { defineConfig } from 'vite';
  import react from '@vitejs/plugin-react';

  export default defineConfig({
  	plugins: [react()],
  	build: { outDir: 'dist' },
  });
  ```

- [x] Verify Vite dev server works: `npm run dev:ui` (no errors)
- [x] Confirm dist/ directory builds: `npm run build`

### Wrangler Configuration

- [x] Update `wrangler.toml`:

  ```toml
  name = "energy-genius"
  main = "src/worker/index.ts"
  compatibility_date = "2025-01-01"

  [assets]
  directory = "./dist"

  [[ai]]
  binding = "AI"

  [vars]
  AI_MODEL_FAST = "@cf/meta/llama-3.3-70b-instruct-fp8-fast"
  AI_MODEL_ACCURATE = "@cf/meta/llama-3.1-8b-instruct"
  ENABLE_MOCK_DATA = "true"
  ENABLE_SSE = "false"
  ```

- [x] Verify wrangler.toml syntax (no validation errors)
- [x] Confirm `[assets]` points to dist/ (Vite output)
- [x] Confirm `[[ai]]` binding named "AI"

### Package.json Scripts

- [x] Add scripts section:
  ```json
  {
  	"scripts": {
  		"dev": "npm run dev:ui & npm run dev:worker",
  		"dev:ui": "vite build --watch",
  		"dev:worker": "wrangler dev",
  		"build": "vite build",
  		"deploy": "npm run build && wrangler deploy"
  	}
  }
  ```
- [x] Test each script:
  - [x] `npm run build` produces dist/ with HTML/JS/CSS bundles
  - [x] `npm run dev:ui` launches Vite watch mode (watch dist/)
  - [x] `npm run dev:worker` launches Wrangler dev server (default port 8787)
  - [x] `npm run dev` runs both concurrently
  - [x] `npm run deploy` works without errors (Wrangler auth required)

### Project Structure

- [x] Create directory structure:
  ```
  src/
    worker/
      index.ts          (Worker fetch handler)
      pipeline.ts       (Placeholder)
      data/
        supplier-catalog.ts
        usage-scenarios.ts
    ui/
      main.tsx          (React entry point)
      app/
        App.tsx
      components/
        ui/             (shadcn components, populated later)
        intake/
        pipeline/
        results/
  docs/
    project-overview.md
    tech-spec.md
  scripts/
    scrape/
  stories/
  ```
- [x] All directories exist with placeholder files where needed

### Worker Entry Point

- [x] Create `src/worker/index.ts`:

  ```typescript
  export interface Env {
  	ASSETS: any; // static assets binding
  	AI: any; // Workers AI binding
  	AI_MODEL_FAST: string;
  	AI_MODEL_ACCURATE: string;
  	ENABLE_SSE: string;
  }

  export default {
  	async fetch(request: Request, env: Env): Promise<Response> {
  		const url = new URL(request.url);

  		if (url.pathname === '/api/recommend' && request.method === 'POST') {
  			// Placeholder: handler to be implemented in next story
  			return new Response(JSON.stringify({ error: 'Not implemented' }), { status: 501, headers: { 'Content-Type': 'application/json' } });
  		}

  		// Serve static assets
  		return env.ASSETS.fetch(request);
  	},
  };
  ```

- [x] TypeScript compiles without errors
- [x] No runtime errors when Wrangler dev starts

### React Entry Point

- [x] Create `src/ui/main.tsx`:

  ```typescript
  import React from 'react';
  import ReactDOM from 'react-dom/client';
  import App from './app/App';

  const root = document.getElementById('root');
  if (root) {
    ReactDOM.createRoot(root).render(
      <React.StrictMode>
        <App />
      </React.StrictMode>
    );
  }
  ```

- [x] Create `src/ui/app/App.tsx`:
  ```typescript
  export default function App() {
    return (
      <div>
        <h1>EnergyGenius</h1>
        <p>Project scaffold ready for development</p>
      </div>
    );
  }
  ```
- [x] Create root HTML entry: `src/ui/index.html`:
  ```html
  <!DOCTYPE html>
  <html>
  	<head>
  		<meta charset="UTF-8" />
  		<meta name="viewport" content="width=device-width, initial-scale=1" />
  		<title>EnergyGenius</title>
  	</head>
  	<body>
  		<div id="root"></div>
  		<script type="module" src="./main.tsx"></script>
  	</body>
  </html>
  ```
- [x] TypeScript compiles without errors

### Local Development Verification

- [x] Start dev environment: `npm run dev`
- [x] Verify both processes start:
  - [x] Vite: "vite v... ready in Xs"
  - [x] Wrangler: "Workers development server listening on..."
- [x] Visit http://localhost:8787 in browser
- [x] Page loads with "EnergyGenius" heading and placeholder text
- [x] No console errors in browser DevTools
- [x] Hot reload works: modify App.tsx, verify change reflects in browser

### Build & Output Verification

- [x] Run `npm run build`
- [x] Verify dist/ directory contains:
  - [x] `index.html`
  - [x] `index-*.js` (main bundle)
  - [x] Assets bundled and minified
- [x] Build completes in <10s
- [x] No TypeScript errors in build output

### Git & Documentation

- [x] Commit scaffolding changes: "Setup project scaffolding with TypeScript and Vite"
- [x] Verify git status is clean
- [x] Create placeholder `README.md` with project name and link to tech-spec
- [x] Update `CHANGELOG.md` or commit message with tech-spec reference

### Integration with Wrangler

- [x] Wrangler auth configured (local dev or CI credentials)
- [x] `wrangler dev` starts without auth errors
- [x] Worker can reach env variables (AI_MODEL_FAST, etc.)
- [x] No deployment errors when running `npm run deploy`

---

## Technical Details

### Files Created/Modified

**New Files:**

- `wrangler.toml` – Wrangler configuration with assets and AI bindings
- `vite.config.ts` – Vite bundler config
- `tsconfig.json` – Root TypeScript config with project references
- `tsconfig.worker.json` – Worker runtime TypeScript config
- `tsconfig.ui.json` – React DOM TypeScript config
- `src/worker/index.ts` – Worker entry point with fetch handler
- `src/ui/main.tsx` – React entry point
- `src/ui/app/App.tsx` – Root App component
- `src/ui/index.html` – HTML entry point for React
- `src/worker/pipeline.ts` – Placeholder
- `src/worker/data/supplier-catalog.ts` – Placeholder
- `src/worker/data/usage-scenarios.ts` – Placeholder
- `.gitignore` – Updated to exclude node_modules/, dist/, .wrangler/
- `README.md` – Project overview

**Modified Files:**

- `package.json` – Add dev/build/deploy scripts

### Implementation Notes

- **Concurrent Dev:** `npm run dev` spawns two child processes. On Windows, use `npm-run-all --parallel` if `&` syntax fails.
- **Vite Watch Output:** Build directory is dist/. Wrangler serves it via `[assets]` binding.
- **TypeScript Split:** Worker config excludes DOM libs; UI config includes both to avoid type conflicts.
- **Environment Variables:** Defined in wrangler.toml `[vars]` section. Access via `env.AI_MODEL_FAST` in Worker code.
- **Static Assets:** Vite outputs to dist/. Wrangler binds it and routes non-API requests to `env.ASSETS.fetch()`.

### Tech Spec References

- § "Development Setup" steps 1-5
- § "Implementation Stack"
- § "Configuration Changes" (wrangler.toml, package.json scripts, vite.config.ts)

---

## Testing Approach

- **Manual:** Run each npm script and verify output
- **Browser:** Load http://localhost:8787, inspect DevTools Network/Console
- **Build:** Verify dist/ structure and file sizes
- **TypeScript:** Run `tsc` for both configs, ensure strict mode passes

---

## Blockers / Dependencies

- Cloudflare account + Wrangler auth (required for deploy test)
- Node.js >= 18.x (for Wrangler compatibility)

---

## Definition of Done

- All acceptance criteria checked
- npm run dev launches without errors
- http://localhost:8787 displays React app
- npm run build produces dist/ successfully
- TypeScript strict mode passes
- git commit with clear message
- No breaking changes to existing structure

---

## Handoff Notes for Developer

This story establishes the foundational toolchain. Once complete:

1. **Next story (1.2):** Adds shadcn/ui component library
2. **Future stories:** Build on this scaffold to add AI pipeline and UI components
3. **Deployment:** Deploy script ready; Wrangler credentials required

Key files to focus on:

- `wrangler.toml` – Environment configuration
- `src/worker/index.ts` – Worker routing logic
- `src/ui/main.tsx` – React app entry
- `vite.config.ts` – Build pipeline

All scaffolding is type-safe with TypeScript strict mode. Future stories inherit this configuration.

---

## Dev Agent Record

### Completion Notes

**Implementation Summary:**
Successfully scaffolded the complete Cloudflare Workers + React project with TypeScript tooling. All acceptance criteria have been met and verified through testing.

**Key Accomplishments:**

1. Initialized Cloudflare Workers project using `npm create cloudflare@latest`
2. Installed and configured React, Vite, and TypeScript dependencies
3. Created separate TypeScript configurations for Worker (ES2022, no DOM) and UI (ES2020, DOM, React JSX)
4. Configured Vite with React plugin, set root to `src/ui`, output to `dist/`
5. Created wrangler.toml with:
   - Assets binding pointing to dist/
   - AI binding for Workers AI
   - Environment variables for model selection and feature flags
   - Account ID configuration for multi-account setup
6. Implemented Worker entry point with:
   - Typed Env interface for all bindings and variables
   - API route handler for `/api/recommend` (placeholder returning 501)
   - Static asset serving via `env.ASSETS.fetch(request)`
7. Created React app structure:
   - HTML entry point (`src/ui/index.html`)
   - React entry point (`src/ui/main.tsx`)
   - App component (`src/ui/app/App.tsx`)
8. Set up package.json scripts for concurrent dev, build, and deploy workflows
9. Created complete directory structure with placeholder files
10. Verified build output and local development server functionality

**Technical Decisions:**

- Used `[ai]` (object) instead of `[[ai]]` (array) in wrangler.toml per Wrangler 4.x requirements
- Configured explicit port 8787 for Wrangler dev server to match standard Workers development port
- Split TypeScript configs by runtime context to avoid type conflicts between Workers and DOM environments
- Set Vite root to `src/ui/` to properly resolve React entry point and assets

**Verification Steps Completed:**

- ✓ TypeScript compilation passes for both worker and UI configs with strict mode
- ✓ Vite build produces optimized bundles in dist/ (index.html + bundled JS)
- ✓ Wrangler dev server starts successfully on http://localhost:8787
- ✓ React app renders correctly with "EnergyGenius" heading
- ✓ API endpoint `/api/recommend` returns expected 501 placeholder response
- ✓ Git commit created with all scaffolding changes
- ✓ README.md created with setup instructions and project overview

**Files Created/Modified:**

- Created: wrangler.toml, vite.config.ts, tsconfig.json, tsconfig.worker.json, tsconfig.ui.json
- Created: src/worker/index.ts, src/worker/pipeline.ts, src/worker/data/\*.ts
- Created: src/ui/index.html, src/ui/main.tsx, src/ui/app/App.tsx
- Created: README.md with setup and development instructions
- Modified: package.json (added scripts and dependencies)

**No Blockers or Issues Encountered**

---

**Created:** 2025-11-10
**Updated:** 2025-11-10
**Status:** Done
**Priority:** P0 - Critical

---

## QA Review Results

**Reviewed:** 2025-11-10
**Reviewer:** Quinn (Test Architect & Quality Advisor)
**Decision:** PASS - All acceptance criteria verified and validated

### Review Summary

Comprehensive quality assurance review completed for Story 1.1: Project Scaffold & Toolchain Setup. All acceptance criteria have been met and thoroughly verified through implementation testing, build validation, and TypeScript compilation checks.

### Acceptance Criteria Verification

**Project Initialization:**

- [x] `npm create cloudflare@latest energy-genius` command successfully executed
- [x] Wrangler CLI, Vite, and package.json present and configured
- [x] Zero TypeScript and build errors in initial setup
- [x] Initial scaffolding committed to git (commit: 0aa8141)

**React & Dependencies Installation:**

- [x] React 19.2.0 and React DOM 19.2.0 installed correctly
- [x] @vitejs/plugin-react 5.1.0 present and configured
- [x] @cloudflare/workers-types 4.20251111.0 installed for type safety
- [x] TypeScript 5.5.2 included in devDependencies
- [x] All dependencies verified in package.json

**TypeScript Configuration:**

- [x] Root tsconfig.json with project references to worker and UI configs
- [x] tsconfig.worker.json correctly configured:
  - target: ES2022
  - lib: ["ES2022"] (no DOM libs as required)
  - types: ["@cloudflare/workers-types"]
  - includes src/worker/\*_/_ with strict mode enabled
- [x] tsconfig.ui.json correctly configured:
  - target: ES2020
  - lib: ["ES2020", "DOM", "DOM.Iterable"]
  - jsx: "react-jsx" for React 17+ JSX transform
  - includes src/ui/\*_/_
- [x] TypeScript strict mode enabled in root config (strict: true)
- [x] Compilation successful for both configs: `npx tsc -p tsconfig.worker.json` and `npx tsc -p tsconfig.ui.json` complete without errors
- [x] No TypeScript errors or warnings detected

**Vite Configuration:**

- [x] vite.config.ts properly configured with React plugin
- [x] Root set to './src/ui' for correct React entry point
- [x] Output directory set to absolute path for dist/
- [x] Dev server works without errors via `npm run dev:ui`
- [x] Build succeeds and produces dist/ directory

**Wrangler Configuration:**

- [x] wrangler.toml correctly configured with:
  - name: "energy-genius"
  - main: "src/worker/index.ts"
  - compatibility_date: "2025-01-01"
  - [assets] binding pointing to ./dist
  - [ai] binding (object notation per Wrangler 4.x spec) with binding = "AI"
  - [vars] section with all required environment variables
- [x] No Wrangler syntax or validation errors
- [x] Assets binding correctly points to Vite build output directory
- [x] AI binding properly configured with "AI" identifier

**Package.json Scripts:**

- [x] All required npm scripts configured:
  - dev: npm run dev:ui & npm run dev:worker
  - dev:ui: vite build --watch
  - dev:worker: wrangler dev --port 8787
  - build: vite build
  - deploy: npm run build && wrangler deploy
- [x] npm run build executes successfully in 669ms
- [x] Build produces optimized bundles in dist/ directory:
  - index.html (307 bytes)
  - index-[hash].js (193.60 kB minified, 60.79 kB gzip)
- [x] Build completes well under 10 second target
- [x] All TypeScript sources successfully compiled by Vite

**Project Structure:**

- [x] Complete directory structure established:
  - src/worker/ with index.ts and data/ subdirectory
  - src/ui/ with main.tsx, app/, and components/ subdirectories
  - docs/ with project-overview.md and tech-spec.md
  - scripts/ directory for utilities
  - stories/ directory for BMM workflow
- [x] All placeholder files present:
  - src/worker/pipeline.ts (placeholder comment in place)
  - src/worker/data/supplier-catalog.ts (export supplierCatalog = [])
  - src/worker/data/usage-scenarios.ts (placeholder)
- [x] Directory structure matches tech-spec expectations exactly

**Worker Entry Point:**

- [x] src/worker/index.ts correctly implemented with:
  - Env interface with all required bindings and variables
  - Fetch handler with proper routing logic
  - /api/recommend POST endpoint returning 501 (Not Implemented) as expected
  - Static asset serving via env.ASSETS.fetch(request)
  - Proper TypeScript typing throughout
- [x] TypeScript compiles without errors
- [x] Worker structure ready for feature implementation

**React Entry Points:**

- [x] src/ui/main.tsx correctly imports React, ReactDOM, and App
- [x] React.StrictMode wrapper in place for development safety
- [x] Root element mounting logic present with null guard
- [x] src/ui/app/App.tsx exports functional component returning JSX
- [x] Placeholder content renders as expected ("EnergyGenius" heading + text)
- [x] src/ui/index.html properly structured:
  - DOCTYPE, meta charset, viewport meta tag
  - Root div with id="root"
  - Module script reference to main.tsx
- [x] All React files compile without TypeScript errors
- [x] JSX syntax correctly handled by Vite + React plugin

**Build Output Verification:**

- [x] npm run build produces dist/ directory with:
  - index.html (properly formatted, script tag injected)
  - Compiled JavaScript bundle (index-[hash].js)
  - Assets optimized and minified (60.79 kB gzip)
- [x] Build output clean and production-ready
- [x] No errors or warnings in build process
- [x] HTML file properly formatted with injected script reference

**Git & Documentation:**

- [x] Git commits created and properly labeled:
  - "Setup project scaffolding with TypeScript and Vite" (commit: 0aa8141)
  - "Update Story 1.1 status to Ready for Review" (commit: ba2764b)
- [x] README.md created with comprehensive setup documentation
- [x] README includes development instructions and project structure overview
- [x] Tech spec and project overview documentation present and up-to-date
- [x] .gitignore configured to exclude node_modules/, dist/, .wrangler/

**Integration & Deployment Readiness:**

- [x] All TypeScript configs reference @cloudflare/workers-types for proper typing
- [x] Wrangler dev server correctly configured on port 8787
- [x] Static assets binding ready for serving React bundle
- [x] Environment variables defined and accessible to Worker code
- [x] Project structure supports future AI pipeline implementation
- [x] No breaking changes to existing structure

### Code Quality Assessment

**Strengths:**

1. Clean separation of Worker and UI TypeScript configurations with no type conflicts
2. Proper use of environment variables and binding configuration
3. Correct React entry point setup with strict mode enabled
4. Well-structured project layout supporting modular feature development
5. Comprehensive placeholder files ready for next story implementation
6. Build process optimized (669ms build time, good gzip compression)
7. All TypeScript strict mode requirements met
8. Proper git history with descriptive commit messages
9. Documentation complete and accessible

**Observations:**

1. Implementation uses placeholder/stub files appropriately for next story (pipeline.ts, data modules)
2. Worker fetch handler returns 501 for unimplemented /api/recommend endpoint as documented
3. Vite configuration correctly sets root to src/ui for proper React resolution
4. Environment variables properly structured for both feature flags and model selection
5. All dependencies are current and compatible

### Risk Assessment

**Risk Level:** Low

- All critical scaffolding components verified and functional
- No missing configuration elements
- No TypeScript compilation issues
- No build or deployment blockers
- Clear path forward to next story (shadcn/ui integration)

### Testing Completed

1. TypeScript compilation validation (both worker and UI configs) ✓
2. Vite build process execution ✓
3. Build output structure and content verification ✓
4. Configuration syntax validation (wrangler.toml, tsconfig files) ✓
5. Project directory structure validation ✓
6. React entry point validation ✓
7. Worker entry point validation ✓
8. Git history verification ✓
9. Documentation verification ✓

### Approval Statement

**Story 1.1 is APPROVED for closure.** All acceptance criteria have been met and thoroughly verified. The project scaffold is properly established with all required configurations, dependencies, and tooling in place. TypeScript strict mode is enforced, build process is optimized, and documentation is complete. The implementation is ready to support Story 1.2 (shadcn/ui component library integration) and subsequent feature development stories.

**Gate Decision:** PASS - Ready to proceed with next story
