# Story 8.3: Fix Progress Duration Display - Show Correct Elapsed Time

**Epic:** Epic 8 - Critical Bug Fixes (Post-Deployment)
**Status:** Ready for Development
**Priority:** P2 - Low (Cosmetic)
**Complexity:** Low
**Owner:** Dev Team

---

## User Story

As a user, I should see the correct elapsed time when a recommendation request completes. Currently the progress shows elapsed time correctly while running, but once complete it displays "Duration 0s" instead of showing the total time taken. This is a minor UX issue that confuses users about how long the request took.

---

## Acceptance Criteria

### 1. Investigate Progress Duration Issue

- [ ] Understand current progress display:
  - [ ] Review ProgressTimeline component code
  - [ ] Understand how duration is calculated
  - [ ] Check what happens when status changes to "complete"
  - [ ] Identify where "Duration 0s" is coming from
- [ ] Test the progress display:
  - [ ] Generate a recommendation request
  - [ ] Watch progress timeline while running
  - [ ] Check what's displayed while running
  - [ ] Check what's displayed when complete
  - [ ] Manually verify how long it actually took
- [ ] Check the data flow:
  - [ ] What data is passed to ProgressTimeline?
  - [ ] How is duration calculated from start/end times?
  - [ ] When is the status changed to complete?
  - [ ] Is duration recalculated after completion?
- [ ] Trace the timer logic:
  - [ ] How is the timer started?
  - [ ] How is it updated while running?
  - [ ] What happens when request completes?
  - [ ] Is there a race condition in timing?
- [ ] Developer has full authority to investigate without restrictions

### 2. Identify Root Cause of Duration Display

Possible causes to investigate:
- [ ] **Duration State Not Updated**: Component uses state for duration
  - [ ] Check if duration state is updated on completion
  - [ ] Verify state change triggers re-render
  - [ ] Check for stale closure capturing old duration
- [ ] **Race Condition**: Duration calculation happens before endTime is set
  - [ ] Check timing of state updates
  - [ ] Verify endTime is set before duration calc
  - [ ] Look for timing dependencies
- [ ] **Incorrect Duration Calculation**: Formula is wrong
  - [ ] Check if calculation uses correct timestamps
  - [ ] Verify math is correct (endTime - startTime)
  - [ ] Check for unit conversion issues (ms vs seconds)
- [ ] **Display Logic Issue**: Calculation correct but display is wrong
  - [ ] Check if duration is displayed before being set
  - [ ] Look for conditional rendering
  - [ ] Check for fallback display value
- [ ] **Status Change Side Effect**: Something resets duration when status changes
  - [ ] Check useEffect dependencies
  - [ ] Look for state resets on status change
  - [ ] Verify state cleanup logic
- [ ] **Timing Mismatch**: Frontend duration doesn't match request duration
  - [ ] Check if frontend timer matches server time
  - [ ] Verify no clock skew issues
  - [ ] Check if duration is from frontend or backend

### 3. Fix Duration Calculation and Display

Implement fix based on root cause:

- [ ] **If Duration Not Updated**:
  - [ ] Add state update for duration on completion
  - [ ] Ensure state update happens after endTime is set
  - [ ] Verify component re-renders with new duration
  - [ ] Test that duration displays correctly

- [ ] **If Race Condition**:
  - [ ] Ensure proper dependency ordering
  - [ ] Use useEffect to calculate duration when status changes
  - [ ] Verify endTime is available before calculation
  - [ ] Test timing under various conditions

- [ ] **If Calculation Wrong**:
  - [ ] Fix duration formula
  - [ ] Ensure correct unit handling (ms vs seconds)
  - [ ] Verify calculation matches actual elapsed time
  - [ ] Add unit tests for calculation

- [ ] **If Display Issue**:
  - [ ] Update display logic to show current duration value
  - [ ] Ensure display uses correct state variable
  - [ ] Add fallback for missing duration
  - [ ] Test display renders correctly

- [ ] **If Status Change Side Effect**:
  - [ ] Check and fix useEffect dependencies
  - [ ] Ensure state isn't reset on status change
  - [ ] Verify cleanup logic doesn't affect duration
  - [ ] Test that previous duration is preserved

### 4. Test Progress Duration Display

- [ ] Unit tests:
  - [ ] Test duration calculation with various times
  - [ ] Test state updates on status change
  - [ ] Test display formatting
  - [ ] Test edge cases (0 duration, very long, etc.)
- [ ] Component tests:
  - [ ] Test ProgressTimeline with mock data
  - [ ] Verify duration displays correctly
  - [ ] Test status transitions
  - [ ] Verify no console errors
- [ ] Integration tests:
  - [ ] Generate recommendations
  - [ ] Verify progress shows correct duration while running
  - [ ] Verify completion shows total elapsed time
  - [ ] Test with various request lengths
- [ ] Manual testing:
  - [ ] Generate short requests (test immediate completion)
  - [ ] Generate long requests (test extended progress)
  - [ ] Verify duration is accurate
  - [ ] Check formatting is consistent

### 5. Verify No Regressions

- [ ] Progress timeline still works while running:
  - [ ] Timer updates while request is in progress
  - [ ] Duration increases smoothly
  - [ ] No flickering or jumps in duration
- [ ] Progress timeline works on completion:
  - [ ] Final duration displays correctly
  - [ ] Status changes to complete properly
  - [ ] No errors when request finishes
- [ ] Other progress features unaffected:
  - [ ] Progress bars still animate
  - [ ] Status messages still display
  - [ ] Completion callbacks still fire
  - [ ] All other components still work

### 6. Validation & Commit

- [ ] Final verification:
  - [ ] Generate recommendations and verify duration
  - [ ] Check multiple requests
  - [ ] Verify formatting is consistent
  - [ ] Run all tests and verify passing
- [ ] Update documentation if needed:
  - [ ] Document ProgressTimeline duration behavior
  - [ ] Add comments to duration calculation
  - [ ] Update dev notes if logic changed
- [ ] Commit message: "Fix progress duration display - Show correct elapsed time on completion"

## Tasks / Subtasks

- [ ] Investigate Duration Issue (AC: Investigate Progress Duration Issue)
  - [ ] Review component code
  - [ ] Test current behavior
  - [ ] Check data flow
  - [ ] Trace timer logic

- [ ] Identify Root Cause (AC: Identify Root Cause of Duration Display)
  - [ ] Check each possible cause
  - [ ] Add debug logging
  - [ ] Isolate the issue
  - [ ] Document root cause

- [ ] Fix Duration Display (AC: Fix Duration Calculation and Display)
  - [ ] Apply fix based on root cause
  - [ ] Update state/calculation as needed
  - [ ] Test the fix
  - [ ] Verify it works

- [ ] Test Thoroughly (AC: Test Progress Duration Display)
  - [ ] Unit tests
  - [ ] Component tests
  - [ ] Integration tests
  - [ ] Manual testing

- [ ] Check for Regressions (AC: Verify No Regressions)
  - [ ] Test progress while running
  - [ ] Test progress on completion
  - [ ] Test other features
  - [ ] Verify no side effects

- [ ] Final Validation (AC: Validation & Commit)
  - [ ] Verify fix works
  - [ ] Update documentation
  - [ ] Run all tests
  - [ ] Commit changes

## Dev Notes

### Investigation Authority

Developer has full authority to:
- Modify ProgressTimeline component
- Change duration calculation logic
- Update state management for progress
- Modify or add tests
- Investigate timing logic
- Refactor component structure if needed

### Key Files to Investigate

- Progress component: `/src/ui/components/progress/ProgressTimeline.tsx` or similar
- Progress state/context: Look for progress state management
- Tests: `/test/ProgressTimeline.spec.ts` or similar
- Styles: Check Tailwind classes for display issues

### Debug Approach

1. **Verify the Issue**:
   ```
   npm run dev
   # Generate a recommendation
   # Watch the progress display
   # When complete, check what it shows
   # Note: Should show elapsed time, not 0s
   ```

2. **Add Debug Logging**:
   - Log startTime when request begins
   - Log endTime when request completes
   - Log duration calculation
   - Log what's displayed

3. **Test Different Scenarios**:
   - Quick requests (1-2 seconds)
   - Longer requests (30+ seconds)
   - Very long requests (60+ seconds)
   - Verify duration is accurate in each case

4. **Check Component State**:
   - Use React DevTools to inspect component state
   - Verify duration state value
   - Check if state updates on completion
   - Look for stale closures

### Common Issues

1. **Stale Closure**: Function captures old duration value
   - Solution: Use useCallback or update state properly

2. **Race Condition**: Duration calculated before endTime set
   - Solution: Ensure dependency ordering in useEffect

3. **State Not Updating**: useEffect not triggering
   - Solution: Check dependencies, ensure status change triggers update

4. **Display Bug**: Calculation correct but display wrong
   - Solution: Check rendered value vs state value

### Duration Format

Current format appears to be "Duration Xs" where X is seconds.
Examples:
- "Duration 5s" (5 seconds)
- "Duration 45s" (45 seconds)
- "Duration 0s" (BUG - should be actual duration)

Verify this format is maintained in fix.

### Expected Outcome

After this story:
- Progress shows correct elapsed time while running
- On completion, shows total elapsed time (not 0s)
- Duration format is consistent
- No console errors or warnings
- User experience improved (clear feedback on request time)

## Dev Agent Record

### Context Reference

<!-- Story context XML will be added here by context workflow -->

### Agent Model Used

Claude Sonnet 4.5

## QA Checklist

- [ ] Progress duration displays correctly while running
- [ ] Completion shows correct elapsed time (not 0s)
- [ ] Duration matches actual request time
- [ ] Duration format is consistent
- [ ] No console errors
- [ ] All tests pass
- [ ] No regressions in progress display
- [ ] Works with various request lengths
- [ ] Timing is accurate across requests
- [ ] Component renders without issues

## File List

### Modified Files
- `/src/ui/components/progress/ProgressTimeline.tsx` - Fix duration calculation/display
- `/test/ProgressTimeline.spec.ts` - Add/update tests for duration

### New Files
- None

### Deleted Files
- None

## Change Log

### 2025-11-11 - Story 8.3 Created: Fix Progress Duration Display - Show Correct Elapsed Time

**Problem**: Progress timeline shows "Duration 0s" when request completes, instead of showing the total elapsed time that was being counted correctly before completion.

**Root Cause**: Duration calculation or display logic fails when status changes to "complete" - likely a state update issue or race condition.

**Solution**: Fix duration state update on completion, ensure calculation happens after endTime is set, and verify display uses current duration value.

**Impact**:
- Users see actual request time instead of confusing "0s"
- Better UX feedback on system performance
- Minor cosmetic improvement but important for clarity

