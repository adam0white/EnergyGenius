# Story 10.4: Move Cost Calculations from LLM to TypeScript

**Epic:** Epic 10 - Critical Production Bugs
**Status:** Ready for Development
**Priority:** P0 - Critical (Production Risk)
**Complexity:** Medium
**Owner:** Dev Team

---

## User Story

As a user viewing energy plan recommendations, I need cost calculations to be performed by reliable code, not AI arithmetic, so that I can trust the savings estimates shown to me.

---

## Problem Statement

**CRITICAL ISSUE CONFIRMED BY INVESTIGATION 10.2**

The current system asks the LLM (Claude) to perform arithmetic calculations for cost and savings on every plan. This creates a hallucination risk where the AI might make arithmetic errors, and users would see incorrect numbers.

### Current Flow (PROBLEMATIC):

1. Stage 2 (Plan Scoring): LLM receives prompt that says "Calculate: Estimated annual cost = (baseRate × totalAnnualUsage) + (monthlyFee × 12)"
2. LLM performs multiplication and subtraction for 100+ plans
3. LLM returns estimated annual cost and savings for each plan
4. Parser takes LLM's calculated numbers and shows them to users
5. No validation that LLM's math is correct

### Risk Factors:

- **LLMs can hallucinate numbers**: Even with explicit instructions, AI can make arithmetic errors
- **No validation**: Parser doesn't verify LLM's calculations, just passes them through
- **All users affected**: Every recommendation shown is based on LLM arithmetic
- **Silent failure**: If LLM calculates wrong, users see incorrect savings with no warning
- **Fallback exists but not primary path**: TypeScript calculations in `retry.ts` only used if LLM completely fails to respond

### Evidence from Investigation 10.2 (AC5):

```
LLM Involvement in Calculations:
Stage 2 (Plan Scoring):
- LLM is instructed to calculate costs
- Formula: Estimated annual cost = (baseRate × totalAnnualUsage) + (monthlyFee × 12)
- Savings: currentAnnualCost - estimatedAnnualCost
- Risk: MEDIUM-HIGH - LLM performs multiplication and subtraction for every plan

Current Implementation Problem:
- ✗ LLM DOES calculate costs (not just score)
- ✗ Parser doesn't verify math
- ✓ Fallback exists but only used if LLM completely fails
- ✓ All inputs provided (LLM doesn't need to guess)
- ✗ Best practice violation: LLMs should NOT do arithmetic
```

---

## Acceptance Criteria

### 1. Move Calculations to TypeScript Code (Backend)

**File:** `src/worker/pipeline.ts`

**Current State (Stage 2 - Plan Scoring):**
- Prompt instructs LLM to calculate costs
- Lines 101-102: Explicit calculation formula in prompt
- Parser: Lines 410-414 pass through LLM's numbers

**Required Changes:**

- [ ] **Remove cost calculations from Stage 2 prompt**
  - [ ] Delete lines that say "Calculate: Estimated annual cost = ..."
  - [ ] Delete lines that say "Estimated savings = ..."
  - [ ] LLM should ONLY score and rank plans (qualitative, not quantitative)

- [ ] **Keep in prompt (don't remove):**
  - [ ] Plan scoring logic (how to evaluate plans)
  - [ ] References to plan attributes (baseRate, monthlyFee, renewablePercent)
  - [ ] Examples of good recommendations

- [ ] **Implement TypeScript cost calculation:**

Create a new function in pipeline or separate utility file:

```typescript
/**
 * Calculate estimated annual cost and savings for a plan
 * ALWAYS use TypeScript, never rely on LLM arithmetic
 */
function calculatePlanCosts(
  plan: { baseRate: number; monthlyFee: number },
  currentAnnualCost: number,
  totalAnnualUsage: number
): {
  estimatedAnnualCost: number;
  estimatedSavings: number;
  savingsPercent: number;
} {
  // Formula: (baseRate × kWh) + (monthlyFee × 12 months)
  const estimatedAnnualCost =
    plan.baseRate * totalAnnualUsage +
    plan.monthlyFee * 12;

  const estimatedSavings = currentAnnualCost - estimatedAnnualCost;
  const savingsPercent = (estimatedSavings / currentAnnualCost) * 100;

  return {
    estimatedAnnualCost,
    estimatedSavings,
    savingsPercent,
  };
}
```

- [ ] **Call TypeScript calculation function:**
  - [ ] Before Stage 2 prompt execution
  - [ ] Calculate all costs for all plans
  - [ ] Pass calculated values to Stage 2 prompt (read-only, for context)
  - [ ] After parsing LLM response, **DO NOT use LLM's cost numbers**
  - [ ] Replace with TypeScript-calculated costs

### 2. Update Stage 2 Prompt to Not Calculate

**File:** `src/worker/prompts/plan-scoring.ts`

**Changes Required:**

Remove these lines (or equivalent):
```
// REMOVE: Cost calculation instructions
"For each plan, calculate:"
"- Estimated annual cost = (baseRate * totalAnnualUsage) + (monthlyFee * 12)"
"- Estimated savings = currentAnnualCost - estimatedAnnualCost"
```

Replace with (NEW):
```
// ADD: Scoring instructions (no calculations)
"For each plan, provide a score (0-100) based on:"
"- User's preferences (renewable, contract length, early termination)"
"- Cost comparison (plans with lower baseRate + monthlyFee are better)"
"- Risk factors (long contracts, high early termination fees)"
"- Value for user's specific usage pattern"

"The estimated annual cost and savings have been pre-calculated."
"Focus on scoring and ranking the plans."
```

- [ ] Ensure prompt provides calculated costs as reference (read-only)
- [ ] Example in prompt: "Plan A: baseRate $0.108/kWh, monthlyFee $9.95, estimated annual cost $1,307"
- [ ] Make clear: "Score this plan on how well it matches the user's needs"

### 3. Update Response Parsing

**File:** `src/worker/pipeline.ts` (parsing section)

**Current Problem:**
```typescript
// WRONG: Trust LLM's calculated numbers
const plan = {
  planId: aiPlan.planId,
  estimatedAnnualCost: aiPlan.estimatedAnnualCost,  // ← LLM calculated
  estimatedSavings: aiPlan.estimatedSavings,        // ← LLM calculated
  score: aiPlan.score,
};
```

**Required Fix:**
```typescript
// RIGHT: Use TypeScript-calculated numbers, ignore LLM's math
const plan = {
  planId: aiPlan.planId,
  estimatedAnnualCost: calculatedCosts[aiPlan.planId].estimatedAnnualCost,  // ← TypeScript
  estimatedSavings: calculatedCosts[aiPlan.planId].estimatedSavings,        // ← TypeScript
  score: aiPlan.score,  // Keep LLM score (it's qualitative)
};
```

- [ ] Look for all lines that access `estimatedAnnualCost` or `estimatedSavings` from LLM response
- [ ] Replace with values from TypeScript `calculatePlanCosts()` function
- [ ] Keep `score` from LLM (scoring is qualitative, LLM is good at this)
- [ ] Verify no LLM-calculated numeric values reach frontend

### 4. Verify Fallback Still Works

**File:** `src/worker/lib/retry.ts`

**Current Fallback Logic:**
- Lines 154-166: TypeScript calculations as fallback if LLM fails
- Formula matches prompt formula (already verified in investigation)

**Required Checks:**
- [ ] Fallback calculation function exists and is correct
- [ ] Fallback is still called if LLM fails completely
- [ ] Fallback formula matches TypeScript primary calculation
- [ ] No changes needed here (fallback is already good)

### 5. Add Validation & Logging

**File:** `src/worker/pipeline.ts`

- [ ] Log when TypeScript calculations are used (info level)
- [ ] Log any discrepancies between TypeScript and LLM numbers (warning level)
  ```typescript
  if (Math.abs(llmCost - tsCalculatedCost) > 1) {
    console.warn(`Cost mismatch for ${planId}: LLM=$${llmCost}, TS=$${tsCalculatedCost}`);
  }
  ```
- [ ] Verify final costs passed to frontend come from TypeScript (debug log)
- [ ] No LLM arithmetic visible in frontend data

---

## Implementation Sequence

1. **Implement TypeScript calculation function** (new utility)
2. **Calculate all plan costs** before Stage 2 prompt
3. **Update Stage 2 prompt** to remove calculation instructions
4. **Update response parsing** to use TypeScript costs instead of LLM costs
5. **Add logging** to verify calculations are TypeScript-based
6. **Test** with sample data to confirm costs are correct
7. **Verify** no LLM arithmetic reaches frontend

---

## Testing & Verification

### Unit Tests (Calculation Function)

- [ ] Test with cheap plan: $0.108/kWh, $9.95/month, 11,000 kWh/year usage
  - Expected: ~$1,307/year
  - Formula: (0.108 × 11,000) + (9.95 × 12) = 1,188 + 119.40 = $1,307.40 ✓

- [ ] Test with expensive plan: $0.19/kWh, $9.95/month, 11,000 kWh/year usage
  - Expected: ~$2,209/year
  - Formula: (0.19 × 11,000) + (9.95 × 12) = 2,090 + 119.40 = $2,209.40 ✓

- [ ] Test savings calculation
  - Current: $1,549/year (11,000 × $0.13/kWh + $9.95 × 12)
  - New plan: $1,307/year
  - Expected savings: $242/year ✓

### Integration Tests

- [ ] Submit intake form and get recommendations
- [ ] Verify recommended costs are realistic (not hallucinated numbers)
- [ ] Verify savings match calculated values
- [ ] Confirm costs vary between recommendations (not all same)
- [ ] Log shows calculations came from TypeScript, not LLM

### Manual Verification

- [ ] Open browser dev tools console
- [ ] Generate recommendations
- [ ] Search logs for "estimatedAnnualCost"
- [ ] Verify source is TypeScript calculation, not LLM
- [ ] Check that costs in UI match expected calculations

---

## Tasks / Subtasks

- [ ] Create TypeScript calculation function in pipeline.ts
- [ ] Calculate all plan costs before Stage 2 prompt execution
- [ ] Update Stage 2 prompt to remove cost calculation instructions
- [ ] Update response parsing to use TypeScript calculations
- [ ] Add logging to verify TypeScript-based calculations
- [ ] Test with multiple user scenarios
- [ ] Verify no LLM arithmetic in final recommendation data
- [ ] Check fallback calculations still work if LLM fails
- [ ] Build and verify no errors

---

## Dev Notes

### Why This Fix Is Critical

**Problem:** Arithmetic is one of the hardest things for LLMs:
- Claude can make calculation errors, especially with multiple numbers
- Error happens silently (no runtime error, just wrong number)
- Users trust displayed numbers and make decisions based on wrong savings

**Solution:** Use TypeScript for all arithmetic
- TypeScript does exact calculations with floating point precision
- Fully testable and predictable
- Can be validated at runtime

**Architecture:**
- **LLM Role**: Score and rank plans (qualitative strength)
- **TypeScript Role**: Calculate costs (deterministic strength)
- **Best of both**: Use each technology where it excels

### Calculation Formula Verification

**From Investigation 10.2 (AC1: Cost Calculation Logic)**

Current formula (correct):
```
estimatedAnnualCost = (baseRate × totalAnnualUsage) + (monthlyFee × 12)
estimatedSavings = currentAnnualCost - estimatedAnnualCost
```

This formula is:
- ✓ Mathematically sound
- ✓ Already in both prompt and fallback code
- ✓ Matches fallback in `retry.ts` lines 154-166

**No changes to formula needed** - just move where it's calculated.

### Example Code Changes

**Before:**
```typescript
// Stage 2: LLM calculates
const response = await callClaudeAPI({
  prompt: `Calculate for each plan: cost = (rate × usage) + (fee × 12), savings = current - cost`,
});
// Returns: { planId: "X", estimatedAnnualCost: 1307.40, estimatedSavings: 242 }

// Parser trusts LLM numbers
const plans = response.map(p => ({
  planId: p.planId,
  estimatedAnnualCost: p.estimatedAnnualCost,  // ← LLM calculated
  estimatedSavings: p.estimatedSavings,        // ← LLM calculated
}));
```

**After:**
```typescript
// Pre-calculate all costs
const costMap = new Map();
for (const plan of supplierPlans) {
  costMap.set(plan.id, calculatePlanCosts(plan, currentAnnualCost, totalAnnualUsage));
}

// Stage 2: LLM only scores
const response = await callClaudeAPI({
  prompt: `Score each plan based on user preferences. Costs already calculated.`,
  providedCosts: costMap, // Reference data for context
});
// Returns: { planId: "X", score: 85 }

// Parser uses TypeScript costs
const plans = response.map(p => ({
  planId: p.planId,
  estimatedAnnualCost: costMap.get(p.planId).estimatedAnnualCost,  // ← TypeScript
  estimatedSavings: costMap.get(p.planId).estimatedSavings,        // ← TypeScript
  score: p.score,  // ← LLM calculated (okay, it's qualitative)
}));
```

---

## Change Log

**2025-11-12 - Story Created by SM**
- Created based on investigation story 10.2 findings (AC5: LLM Involvement)
- Critical risk identified: LLM performs cost calculations, hallucination risk
- Solution: Move calculations to TypeScript code as primary path
- LLM keeps role as scorer/ranker (qualitative strength)
- TypeScript handles arithmetic (deterministic strength)
- Priority: P0 - CRITICAL (Production risk from AI arithmetic)
- Status: Ready for Development
- Implementation guidance provided with code examples
- Can be done in parallel with story 10.3 (independent changes)

