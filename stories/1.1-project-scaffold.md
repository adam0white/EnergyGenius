# Story 1.1: Project Scaffold & Toolchain Setup

**Epic:** Epic 1 - Project Setup & Infrastructure
**Status:** Ready for Development
**Priority:** P0 - Critical Path
**Complexity:** Medium
**Owner:** Dev Team

---

## User Story

As a developer, I need to bootstrap the Cloudflare Workers + React project with TypeScript tooling and build configuration so that the team has a working development environment ready for feature implementation.

---

## Acceptance Criteria

### Project Initialization
- [ ] Run `npm create cloudflare@latest energy-genius` selecting the base Worker template
- [ ] Confirm initial scaffolding includes Wrangler CLI, Vite, and package.json
- [ ] Verify no TypeScript or build errors after initial setup
- [ ] Commit initial scaffolding state to git

### React & Dependencies Installation
- [ ] Install React and React DOM: `npm install react react-dom`
- [ ] Install Vite plugin for React: `npm install -D @vitejs/plugin-react`
- [ ] Install Cloudflare Workers types: `npm install -D @cloudflare/workers-types`
- [ ] Install TypeScript if not already included: `npm install -D typescript`
- [ ] Verify all dependencies in package.json

### TypeScript Configuration
- [ ] Create `tsconfig.json` as root config with project references
- [ ] Create `tsconfig.worker.json` for Workers runtime:
  - [ ] `"target": "ES2022"`
  - [ ] `"lib": ["ES2022"]` (no DOM libs)
  - [ ] `"types": ["@cloudflare/workers-types"]`
  - [ ] Include `src/worker/**/*`
- [ ] Create `tsconfig.ui.json` for React:
  - [ ] `"target": "ES2020"`
  - [ ] `"lib": ["ES2020", "DOM", "DOM.Iterable"]`
  - [ ] JSX support: `"jsx": "react-jsx"`
  - [ ] Include `src/ui/**/*`
- [ ] Verify TypeScript strict mode enabled in root tsconfig
- [ ] Compile both configs without errors: `npx tsc -p tsconfig.worker.json` and `npx tsc -p tsconfig.ui.json`

### Vite Configuration
- [ ] Create `vite.config.ts`:
  ```typescript
  import { defineConfig } from 'vite';
  import react from '@vitejs/plugin-react';

  export default defineConfig({
    plugins: [react()],
    build: { outDir: 'dist' },
  });
  ```
- [ ] Verify Vite dev server works: `npm run dev:ui` (no errors)
- [ ] Confirm dist/ directory builds: `npm run build`

### Wrangler Configuration
- [ ] Update `wrangler.toml`:
  ```toml
  name = "energy-genius"
  main = "src/worker/index.ts"
  compatibility_date = "2025-01-01"

  [assets]
  directory = "./dist"

  [[ai]]
  binding = "AI"

  [vars]
  AI_MODEL_FAST = "@cf/meta/llama-3.3-70b-instruct-fp8-fast"
  AI_MODEL_ACCURATE = "@cf/meta/llama-3.1-8b-instruct"
  ENABLE_MOCK_DATA = "true"
  ENABLE_SSE = "false"
  ```
- [ ] Verify wrangler.toml syntax (no validation errors)
- [ ] Confirm `[assets]` points to dist/ (Vite output)
- [ ] Confirm `[[ai]]` binding named "AI"

### Package.json Scripts
- [ ] Add scripts section:
  ```json
  {
    "scripts": {
      "dev": "npm run dev:ui & npm run dev:worker",
      "dev:ui": "vite build --watch",
      "dev:worker": "wrangler dev",
      "build": "vite build",
      "deploy": "npm run build && wrangler deploy"
    }
  }
  ```
- [ ] Test each script:
  - [ ] `npm run build` produces dist/ with HTML/JS/CSS bundles
  - [ ] `npm run dev:ui` launches Vite watch mode (watch dist/)
  - [ ] `npm run dev:worker` launches Wrangler dev server (default port 8787)
  - [ ] `npm run dev` runs both concurrently
  - [ ] `npm run deploy` works without errors (Wrangler auth required)

### Project Structure
- [ ] Create directory structure:
  ```
  src/
    worker/
      index.ts          (Worker fetch handler)
      pipeline.ts       (Placeholder)
      data/
        supplier-catalog.ts
        usage-scenarios.ts
    ui/
      main.tsx          (React entry point)
      app/
        App.tsx
      components/
        ui/             (shadcn components, populated later)
        intake/
        pipeline/
        results/
  docs/
    project-overview.md
    tech-spec.md
  scripts/
    scrape/
  stories/
  ```
- [ ] All directories exist with placeholder files where needed

### Worker Entry Point
- [ ] Create `src/worker/index.ts`:
  ```typescript
  export interface Env {
    ASSETS: any;  // static assets binding
    AI: any;      // Workers AI binding
    AI_MODEL_FAST: string;
    AI_MODEL_ACCURATE: string;
    ENABLE_SSE: string;
  }

  export default {
    async fetch(request: Request, env: Env): Promise<Response> {
      const url = new URL(request.url);

      if (url.pathname === '/api/recommend' && request.method === 'POST') {
        // Placeholder: handler to be implemented in next story
        return new Response(
          JSON.stringify({ error: 'Not implemented' }),
          { status: 501, headers: { 'Content-Type': 'application/json' } }
        );
      }

      // Serve static assets
      return env.ASSETS.fetch(request);
    },
  };
  ```
- [ ] TypeScript compiles without errors
- [ ] No runtime errors when Wrangler dev starts

### React Entry Point
- [ ] Create `src/ui/main.tsx`:
  ```typescript
  import React from 'react';
  import ReactDOM from 'react-dom/client';
  import App from './app/App';

  const root = document.getElementById('root');
  if (root) {
    ReactDOM.createRoot(root).render(
      <React.StrictMode>
        <App />
      </React.StrictMode>
    );
  }
  ```
- [ ] Create `src/ui/app/App.tsx`:
  ```typescript
  export default function App() {
    return (
      <div>
        <h1>EnergyGenius</h1>
        <p>Project scaffold ready for development</p>
      </div>
    );
  }
  ```
- [ ] Create root HTML entry: `src/ui/index.html`:
  ```html
  <!DOCTYPE html>
  <html>
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>EnergyGenius</title>
    </head>
    <body>
      <div id="root"></div>
      <script type="module" src="./main.tsx"></script>
    </body>
  </html>
  ```
- [ ] TypeScript compiles without errors

### Local Development Verification
- [ ] Start dev environment: `npm run dev`
- [ ] Verify both processes start:
  - [ ] Vite: "vite v... ready in Xs"
  - [ ] Wrangler: "Workers development server listening on..."
- [ ] Visit http://localhost:8787 in browser
- [ ] Page loads with "EnergyGenius" heading and placeholder text
- [ ] No console errors in browser DevTools
- [ ] Hot reload works: modify App.tsx, verify change reflects in browser

### Build & Output Verification
- [ ] Run `npm run build`
- [ ] Verify dist/ directory contains:
  - [ ] `index.html`
  - [ ] `index-*.js` (main bundle)
  - [ ] Assets bundled and minified
- [ ] Build completes in <10s
- [ ] No TypeScript errors in build output

### Git & Documentation
- [ ] Commit scaffolding changes: "Setup project scaffolding with TypeScript and Vite"
- [ ] Verify git status is clean
- [ ] Create placeholder `README.md` with project name and link to tech-spec
- [ ] Update `CHANGELOG.md` or commit message with tech-spec reference

### Integration with Wrangler
- [ ] Wrangler auth configured (local dev or CI credentials)
- [ ] `wrangler dev` starts without auth errors
- [ ] Worker can reach env variables (AI_MODEL_FAST, etc.)
- [ ] No deployment errors when running `npm run deploy`

---

## Technical Details

### Files Created/Modified

**New Files:**
- `wrangler.toml` – Wrangler configuration with assets and AI bindings
- `vite.config.ts` – Vite bundler config
- `tsconfig.json` – Root TypeScript config with project references
- `tsconfig.worker.json` – Worker runtime TypeScript config
- `tsconfig.ui.json` – React DOM TypeScript config
- `src/worker/index.ts` – Worker entry point with fetch handler
- `src/ui/main.tsx` – React entry point
- `src/ui/app/App.tsx` – Root App component
- `src/ui/index.html` – HTML entry point for React
- `src/worker/pipeline.ts` – Placeholder
- `src/worker/data/supplier-catalog.ts` – Placeholder
- `src/worker/data/usage-scenarios.ts` – Placeholder
- `.gitignore` – Updated to exclude node_modules/, dist/, .wrangler/
- `README.md` – Project overview

**Modified Files:**
- `package.json` – Add dev/build/deploy scripts

### Implementation Notes

- **Concurrent Dev:** `npm run dev` spawns two child processes. On Windows, use `npm-run-all --parallel` if `&` syntax fails.
- **Vite Watch Output:** Build directory is dist/. Wrangler serves it via `[assets]` binding.
- **TypeScript Split:** Worker config excludes DOM libs; UI config includes both to avoid type conflicts.
- **Environment Variables:** Defined in wrangler.toml `[vars]` section. Access via `env.AI_MODEL_FAST` in Worker code.
- **Static Assets:** Vite outputs to dist/. Wrangler binds it and routes non-API requests to `env.ASSETS.fetch()`.

### Tech Spec References

- § "Development Setup" steps 1-5
- § "Implementation Stack"
- § "Configuration Changes" (wrangler.toml, package.json scripts, vite.config.ts)

---

## Testing Approach

- **Manual:** Run each npm script and verify output
- **Browser:** Load http://localhost:8787, inspect DevTools Network/Console
- **Build:** Verify dist/ structure and file sizes
- **TypeScript:** Run `tsc` for both configs, ensure strict mode passes

---

## Blockers / Dependencies

- Cloudflare account + Wrangler auth (required for deploy test)
- Node.js >= 18.x (for Wrangler compatibility)

---

## Definition of Done

- All acceptance criteria checked
- npm run dev launches without errors
- http://localhost:8787 displays React app
- npm run build produces dist/ successfully
- TypeScript strict mode passes
- git commit with clear message
- No breaking changes to existing structure

---

## Handoff Notes for Developer

This story establishes the foundational toolchain. Once complete:
1. **Next story (1.2):** Adds shadcn/ui component library
2. **Future stories:** Build on this scaffold to add AI pipeline and UI components
3. **Deployment:** Deploy script ready; Wrangler credentials required

Key files to focus on:
- `wrangler.toml` – Environment configuration
- `src/worker/index.ts` – Worker routing logic
- `src/ui/main.tsx` – React app entry
- `vite.config.ts` – Build pipeline

All scaffolding is type-safe with TypeScript strict mode. Future stories inherit this configuration.

---

**Created:** 2025-11-10
**Status:** Ready for Development
**Priority:** P0 - Critical
