# Story 10.6: Add Tiered Pricing Support

**Epic:** Epic 10 - Critical Production Bugs
**Status:** Ready for Development (DEFERRED - Future Enhancement)
**Priority:** P2 - Medium (Future Enhancement, Not Blocking)
**Complexity:** High
**Owner:** Dev Team (when scheduled)

---

## User Story

As a user with high electricity consumption, I need recommendations to account for tiered pricing plans where the rate varies based on usage levels, so that my savings calculations are accurate for my actual usage pattern.

---

## Problem Statement

**LIMITATION CONFIRMED BY INVESTIGATION 10.2**

Currently, the system only supports flat-rate plans where all kWh are charged at a single price. Many real Texas energy plans use tiered pricing:

- **Tier 1**: 0-500 kWh @ $0.10/kWh
- **Tier 2**: 500-2000 kWh @ $0.12/kWh
- **Tier 3**: 2000+ kWh @ $0.14/kWh

When users have tiered plans (current or recommended), costs are approximated using a flat rate, resulting in 5-10% calculation errors.

### Current Implementation (Flat Rate Only):

```typescript
interface SupplierPlan {
	id: string;
	supplier: string;
	planName: string;
	baseRate: number; // ‚Üê Only ONE rate per plan
	monthlyFee: number;
	contractTermMonths: number;
	// ‚ùå NO support for tier structure
}
```

### Calculation Error Example:

**User consuming 1,500 kWh/month with tiered plan:**

**Actual tiered calculation:**

- 0-500 kWh @ $0.10 = $50
- 500-1500 kWh @ $0.12 = $120
- **Total: $170/month**

**Current flat-rate approximation (using average $0.12):**

- 1500 kWh @ $0.12 = $180/month
- **Error: +$10/month = +$120/year (7% overestimate)**

**Or if using first tier:**

- 1500 kWh @ $0.10 = $150/month
- **Error: -$20/month = -$240/year (14% underestimate)**

### Why This Matters:

- 5-10% error affects users with high consumption
- Accurate cost comparison requires understanding tier boundaries
- Some users intentionally choose plans based on their tier position
- Future scalability: More sophisticated users expect accurate tiered pricing

### Why It's Deferred:

**From Investigation 10.2 (AC4: Tiered Pricing Support):**

```
Current Status:
‚ùå Type definition doesn't support tiers - Only single baseRate field
‚ùå Scraped data has no tier info - All plans use flat rates
‚ùå Calculations assume flat rates - No tier-aware cost calculation

Impact:
‚ö†Ô∏è Accuracy impact: 5-10% for users in tier transition ranges
‚úì Acceptable for MVP - Most Texas plans are flat-rate anyway
üìù Future enhancement - Add tier support if needed for accuracy

Recommendation:
- DEFER this work to post-launch
- Focus on P0 bugs (data quality, calculation reliability) first
- MVP can successfully launch with flat-rate approximation
- Revisit once user feedback indicates tier support is important
```

**Blockers for MVP:**

- Story 10.3 (Fix Monthly Fee Data) - CRITICAL, must complete first
- Story 10.4 (Move Calculations to TypeScript) - CRITICAL, must complete first
- Story 10.5 (Display kWh Rate in UI) - HIGH, improves transparency first

**Can be implemented after above stories.**

---

## Acceptance Criteria

### 1. Extend SupplierPlan Type Definition

**File:** `src/worker/data/types.ts`

**Add tier structure support:**

Option A - Array of tier objects (RECOMMENDED):

```typescript
interface PriceTier {
	minKwh: number; // Minimum kWh for this tier
	maxKwh: number; // Maximum kWh (null = unlimited)
	rate: number; // Rate for this tier
}

interface SupplierPlan {
	id: string;
	supplier: string;
	planName: string;
	baseRate: number; // ‚Üê Keep for flat-rate plans
	monthlyFee: number;
	contractTermMonths: number;
	earlyTerminationFee: number;
	renewablePercent: number;

	// NEW: Tiered pricing support
	tiers?: PriceTier[]; // ‚Üê Optional: for tiered plans
	isTiered?: boolean; // ‚Üê Flag: true if plan uses tiers
}
```

Option B - Separate rate fields (simpler):

```typescript
interface SupplierPlan {
	// ... existing fields

	// Tier rates (optional, for tiered plans)
	tier1Rate?: number; // Rate for first 500 kWh
	tier2Rate?: number; // Rate for 500-2000 kWh
	tier3Rate?: number; // Rate for 2000+ kWh
	isTiered?: boolean; // true if this plan uses tiered rates
}
```

**Recommendation**: Use Option A (array of tiers) for:

- Future flexibility (can handle any number of tiers)
- Cleaner code structure
- Matches real-world Texas electricity market

- [ ] Add PriceTier interface (or tier rate fields)
- [ ] Update SupplierPlan interface with optional tier fields
- [ ] Set tiers = undefined for flat-rate plans (backward compatible)
- [ ] Update TypeScript interfaces throughout codebase

### 2. Update Scraper to Capture Tier Data

**Files:** `docs/scraper/` or scraper scripts

**Requirements:**

- [ ] When scraping powertochoose.org, capture tier information
- [ ] For tiered plans, extract:
  - [ ] Tier 1 rate and kWh limit (usually 0-500)
  - [ ] Tier 2 rate and kWh limit (usually 500-2000)
  - [ ] Tier 3+ rate and kWh limit (usually 2000+)
- [ ] For flat-rate plans, set `tiers = null` or `isTiered = false`
- [ ] Store tier data in new SupplierPlan fields

**Data Validation:**

- [ ] Verify tier rates are in realistic range ($0.08-$0.20/kWh)
- [ ] Verify tier boundaries make sense (ascending order, no gaps)
- [ ] Count how many plans are tiered vs flat-rate
- [ ] Document tier structure for sampled plans

### 3. Implement Tier-Aware Cost Calculation

**File:** `src/worker/pipeline.ts` or new `src/worker/lib/cost-calculator.ts`

**Replace flat-rate calculation with tier-aware logic:**

```typescript
/**
 * Calculate annual cost accounting for tiered pricing
 */
function calculateTieredAnnualCost(plan: SupplierPlan, annualKwh: number): number {
	// If plan doesn't have tier info, fall back to flat rate
	if (!plan.tiers || plan.tiers.length === 0) {
		return plan.baseRate * annualKwh + plan.monthlyFee * 12;
	}

	// Calculate tiered cost
	let tieredCost = 0;
	let remainingKwh = annualKwh;

	for (const tier of plan.tiers) {
		if (remainingKwh <= 0) break;

		const tierSize = tier.maxKwh ? tier.maxKwh - tier.minKwh : remainingKwh;
		const kwhInTier = Math.min(remainingKwh, tierSize);

		tieredCost += kwhInTier * tier.rate;
		remainingKwh -= kwhInTier;
	}

	// Add monthly fee
	return tieredCost + plan.monthlyFee * 12;
}
```

- [ ] Implement tier-aware calculation function
- [ ] Handle edge cases:
  - [ ] Usage exactly at tier boundary
  - [ ] Usage spanning multiple tiers
  - [ ] Usage exceeding all tier limits
- [ ] Fall back to flat-rate for plans without tier data
- [ ] Test with examples from "Problem Statement" section

**Example Test Cases:**

```typescript
// Test 1: Flat-rate plan (should work as before)
plan = { baseRate: 0.12, monthlyFee: 9.95, tiers: null };
cost = calculateTieredAnnualCost(plan, 11000);
assert(cost === 1319.4); // (0.12 * 11000) + (9.95 * 12)

// Test 2: Tiered plan, user in tier 2
plan = {
	monthlyFee: 9.95,
	tiers: [
		{ minKwh: 0, maxKwh: 500, rate: 0.1 },
		{ minKwh: 500, maxKwh: 2000, rate: 0.12 },
		{ minKwh: 2000, maxKwh: null, rate: 0.14 },
	],
};
// Annual: 1500 kWh/month * 12 = 18,000 kWh/year
// Tier 1: 500 * 12 = 6,000 kWh @ $0.10 = $600
// Tier 2: 1000 * 12 = 12,000 kWh @ $0.12 = $1,440
// Tier 3: 0 kWh @ $0.14 = $0
// Monthly fee: $9.95 * 12 = $119.40
// Total: $600 + $1,440 + $119.40 = $2,159.40
cost = calculateTieredAnnualCost(plan, 18000);
assert(cost === 2159.4);
```

### 4. Update Response Parsing

**File:** `src/worker/pipeline.ts` (cost calculation section)

**Current (Stage 2 - must be updated per story 10.4):**

```typescript
const estimatedAnnualCost = plan.baseRate * totalAnnualUsage + monthlyFee * 12;
```

**Updated (tier-aware):**

```typescript
const estimatedAnnualCost = calculateTieredAnnualCost(plan, totalAnnualUsage);
```

- [ ] Replace flat-rate calculation with tier-aware function
- [ ] Function returns correct cost for both tiered and flat-rate plans
- [ ] Maintains backward compatibility (flat-rate still works)

### 5. Update Frontend to Display Tier Information

**File:** `src/ui/components/results/RecommendationDeck.tsx`

**Optional display enhancement (depends on design):**

Option A - Show tier rates (if space allows):

```tsx
{
	plan.isTiered && plan.tiers ? (
		<div className="text-xs text-gray-500 space-y-1">
			<div>Tiered Rates:</div>
			{plan.tiers.map((tier, idx) => (
				<div key={idx}>
					${tier.rate}/kWh (${tier.minKwh}-{tier.maxKwh ?? '‚àû'} kWh)
				</div>
			))}
		</div>
	) : (
		<div className="text-sm text-gray-600">Flat Rate: ${plan.baseRate}/kWh</div>
	);
}
```

Option B - Show indicator only:

```tsx
{
	plan.isTiered && <div className="text-xs text-blue-600 font-semibold">‚ö° Tiered Pricing Plan</div>;
}
```

- [ ] Decide on display approach
- [ ] Update component to show tier info (or simple indicator)
- [ ] Add tooltip explaining tier structure if helpful
- [ ] Maintain clean card layout

### 6. Testing & Validation

**Unit Tests:**

- [ ] Test flat-rate plans still calculate correctly
- [ ] Test tiered plans with users at each tier boundary
- [ ] Test edge cases (exact boundary, exceeding all tiers, zero usage)
- [ ] Verify calculated costs match manual calculations
- [ ] Test with real tier data from Texas market

**Integration Tests:**

- [ ] Generate recommendations with tiered plans mixed in
- [ ] Verify UI displays both flat and tiered plans correctly
- [ ] Verify savings calculations accurate for tiered plans
- [ ] Verify tier structure displays clearly (if shown)

**Data Validation:**

- [ ] Confirm scraped tier data is present for tiered plans
- [ ] Verify at least 20% of plans have tier information
- [ ] Spot-check tier boundaries match powertochoose.org
- [ ] Log percentage of plans that are flat vs tiered

**Accuracy Testing:**

Test with real user scenarios:

```
User A (low usage, 5,000 kWh/year):
- Flat rate: 5,000 * $0.12 = $600
- Tiered: 5,000 * $0.10 (tier 1 only) = $500
- Difference: $100/year (17% cheaper with tiered)

User B (high usage, 26,000 kWh/year):
- Flat rate: 26,000 * $0.12 = $3,120
- Tiered: (6,000 * $0.10) + (12,000 * $0.12) + (8,000 * $0.14) = 600 + 1,440 + 1,120 = $3,160
- Difference: $40/year (1% more expensive due to tier 3)
```

---

## Implementation Sequence (When Scheduled)

1. **After Story 10.3 & 10.4 complete** (data accuracy and calculation reliability must be solid first)
2. Extend type definitions with tier support
3. Update scraper to capture tier data
4. Implement tier-aware cost calculation
5. Update calculation pipeline
6. Update UI to display tier info (optional enhancement)
7. Comprehensive testing with real data
8. Deploy and monitor accuracy improvements

---

## Tasks / Subtasks

- [ ] Design tier data structure (Option A or B)
- [ ] Update SupplierPlan type definition
- [ ] Update scraper to capture tier information
- [ ] Implement calculateTieredAnnualCost() function
- [ ] Update pipeline to use tier-aware calculation
- [ ] Write unit tests for tier calculations
- [ ] Test with real market data from powertochoose.org
- [ ] Update UI to display tier information (optional)
- [ ] Integration testing with mixed flat/tiered plans
- [ ] Verify accuracy improvements over flat-rate approximation

---

## Dev Notes

### Why This Is P2 (Deferred)

**Accuracy Impact**: 5-10% error

- Real impact only when:
  - User's annual usage crosses tier boundary
  - User switches between tiers with different rates
  - High-consumption users (>20,000 kWh/year)

**Market Reality**: Most Texas plans are flat-rate

- Tiered plans exist but less common
- MVP can launch with flat-rate approximation
- Users won't immediately notice 5-10% error

**Implementation Complexity**: HIGH

- Requires type changes throughout codebase
- Scraper needs updating
- Calculation logic becomes more complex
- Testing requires tier data validation

**MVP Success**: Not required

- Story 10.3 fixes critical data bug (all same fee)
- Story 10.4 fixes calculation reliability (LLM arithmetic)
- Story 10.5 adds transparency (show rates to users)
- Tier support can come in post-launch improvement cycle

### Real-World Example

**Texas energy market (circa 2025):**

- ~80% flat-rate plans: $0.10-0.15/kWh flat
- ~20% tiered plans: $0.08-0.12 (tier 1), $0.10-0.14 (tier 2), $0.12-0.16 (tier 3)

**When tier support matters:**

1. User with 25,000 kWh/year (high consumption)
2. Currently paying flat $0.14/kWh = $3,500/year
3. Switches to tiered plan: $0.10/$0.12/$0.14
4. New cost: ~$3,200/year (8% savings)
5. Without tier support: Shows as $3,500/year (no apparent savings)

### Risk Assessment

**Low Risk:**

- Type changes are backward compatible (tiers optional)
- Function falls back to flat-rate if no tier data
- No breaking changes to existing calculations

**Moderate Risk:**

- Scraper must reliably capture tier information
- Tier boundary logic could have off-by-one errors
- Testing requires real market data validation

**High Priority Later:**

- After MVP launch with accurate flat-rate data
- User feedback will indicate if tier accuracy matters
- May not be necessary if target market is low-consumption users

---

## Related Stories

- **Story 10.3** (Fix Monthly Fee Data): Must complete first
- **Story 10.4** (Move Calculations to TypeScript): Must complete first
- **Story 10.5** (Display kWh Rate): Complements this with rate transparency
- **Story 10.7** (Web Scraper): May provide scraper implementation if needed

---

## Change Log

**2025-11-12 - Story Created by SM**

- Created based on investigation story 10.2 findings (AC4: Tiered Pricing)
- Issue identified: 5-10% calculation error for tiered plans
- Scope defined: Type changes, scraper update, calculation logic
- Decision: Deferred to post-launch (FUTURE ENHANCEMENT)
- Rationale: MVP can launch with flat-rate approximation
- Priority: P2 - Medium (low market impact, complex implementation)
- Complexity: HIGH (type changes, scraper, calculation logic)
- Status: Ready for Development (when scheduled after 10.3 & 10.4)
- Blocking stories: 10.3 and 10.4 must complete first
